# 6. ì“°ë ˆë“œì™€ ë™ê¸°í™”

## 6.1 `pthread_create()`, `pthread_join()`

### ê°œìš”

ë¦¬ëˆ…ìŠ¤ì—ì„œ C ì–¸ì–´ë¡œ **ë©€í‹°ìŠ¤ë ˆë“œ í”„ë¡œê·¸ë˜ë°**ì„ í•˜ê¸° ìœ„í•´ì„œëŠ” **POSIX ìŠ¤ë ˆë“œ(POSIX thread, pthread)** ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•œë‹¤.

`pthread_create()` í•¨ìˆ˜ëŠ” ìƒˆ ìŠ¤ë ˆë“œë¥¼ ìƒì„±í•˜ê³ , `pthread_join()` í•¨ìˆ˜ëŠ” íŠ¹ì • ìŠ¤ë ˆë“œê°€ ì¢…ë£Œë  ë•Œê¹Œì§€ í˜¸ì¶œí•œ ìŠ¤ë ˆë“œ(ì¼ë°˜ì ìœ¼ë¡œ ë©”ì¸ ìŠ¤ë ˆë“œ)ê°€ ê¸°ë‹¤ë¦¬ê²Œ í•œë‹¤.

ì´ ë‘ í•¨ìˆ˜ëŠ” ë©€í‹°ìŠ¤ë ˆë“œ í”„ë¡œê·¸ë¨ì˜ **ê¸°ë³¸ êµ¬ì„± ìš”ì†Œ**ì´ë‹¤.

### ìŠ¤ë ˆë“œì™€ í”„ë¡œì„¸ìŠ¤

- í”„ë¡œì„¸ìŠ¤(Process)ëŠ” ë…ë¦½ì ì¸ ì‹¤í–‰ ë‹¨ìœ„ë¡œ **ë…ë¦½ëœ ë©”ëª¨ë¦¬ ê³µê°„**ì„ ê°€ì§„ë‹¤.
- ìŠ¤ë ˆë“œ(Thread)ëŠ” í”„ë¡œì„¸ìŠ¤ ë‚´ì—ì„œ ì‹¤í–‰ë˜ëŠ” íë¦„ìœ¼ë¡œ, **í”„ë¡œì„¸ìŠ¤ì˜ ìì›ì„ ê³µìœ **í•œë‹¤. (ì½”ë“œ ì˜ì—­, ë°ì´í„° ì˜ì—­, í™, ì—´ë¦° íŒŒì¼ ë””ìŠ¤í¬ë¦½í„° ë“±)

ìŠ¤ë ˆë“œëŠ” ì»¤ë„ì—ì„œ ìŠ¤ì¼€ì¤„ë§ë˜ë¯€ë¡œ ì§„ì •í•œ ë™ì‹œ ì‹¤í–‰(ë©€í‹°ì½”ì–´ CPUì—ì„œ ë³‘ë ¬ ì‹¤í–‰ ê°€ëŠ¥)ì„ ì§€ì›í•œë‹¤.

------

### pthread_create()

#### í•¨ìˆ˜ ì›í˜•

```
#include <pthread.h>

int pthread_create(pthread_t *thread,
                   const pthread_attr_t *attr,
                   void *(*start_routine)(void *),
                   void *arg);
```

#### ë§¤ê°œë³€ìˆ˜ ì„¤ëª…

| ë§¤ê°œë³€ìˆ˜        | ì„¤ëª…                                              |
| --------------- | ------------------------------------------------- |
| `thread`        | ìƒì„±ëœ ìŠ¤ë ˆë“œì˜ IDë¥¼ ë°˜í™˜í•  ë³€ìˆ˜ (pthread_t íƒ€ì…) |
| `attr`          | ìŠ¤ë ˆë“œ ì†ì„± (ê¸°ë³¸ê°’ ì‚¬ìš© ì‹œ `NULL`)               |
| `start_routine` | ìƒˆ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰í•  í•¨ìˆ˜ì˜ í¬ì¸í„°                |
| `arg`           | `start_routine`ì— ì „ë‹¬í•  ì¸ì (`void *` íƒ€ì…)     |

#### ë°˜í™˜ê°’

- `0` â†’ ì„±ê³µ
- `ì—ëŸ¬ ì½”ë“œ` â†’ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ì½”ë“œ ë°˜í™˜

#### `start_routine` í•¨ìˆ˜ í˜•ì‹

```
void *start_routine(void *arg);
```

- ìŠ¤ë ˆë“œ í•¨ìˆ˜ëŠ” ë°˜ë“œì‹œ `void *` ë°˜í™˜í˜•, `void *` ì¸ì í˜•ì‹ì„ ê°€ì ¸ì•¼ í•œë‹¤.
- í•¨ìˆ˜ ì¢…ë£Œ ì‹œ `pthread_exit()` í˜¸ì¶œí•˜ê±°ë‚˜ returnìœ¼ë¡œ ë°˜í™˜ê°’ì„ ì¤„ ìˆ˜ ìˆë‹¤.

------

### pthread_join()

#### í•¨ìˆ˜ ì›í˜•

```
#include <pthread.h>

int pthread_join(pthread_t thread, void **retval);
```

#### ë§¤ê°œë³€ìˆ˜ ì„¤ëª…

| ë§¤ê°œë³€ìˆ˜ | ì„¤ëª…                                                 |
| -------- | ---------------------------------------------------- |
| `thread` | ê¸°ë‹¤ë¦´ ìŠ¤ë ˆë“œì˜ pthread_t ê°’                         |
| `retval` | ìŠ¤ë ˆë“œ ì¢…ë£Œ ì‹œ ë°˜í™˜í•œ ê°’ í¬ì¸í„° (í•„ìš” ì—†ìœ¼ë©´ `NULL`) |

#### ë°˜í™˜ê°’

- `0` â†’ ì„±ê³µ
- `ì—ëŸ¬ ì½”ë“œ` â†’ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ì½”ë“œ ë°˜í™˜

#### ì„¤ëª…

- `pthread_join()` í˜¸ì¶œ ì‹œ í•´ë‹¹ ìŠ¤ë ˆë“œê°€ ì¢…ë£Œë  ë•Œê¹Œì§€ **í˜„ì¬ ìŠ¤ë ˆë“œê°€ ë¸”ë¡(block)** ëœë‹¤.
- ìŠ¤ë ˆë“œ ì¢…ë£Œ ì‹œ ë°˜í™˜í•œ ê°’ì„ `retval`ë¡œ ë°›ì„ ìˆ˜ ìˆë‹¤.

------

#### ê¸°ë³¸ ì˜ˆì œ

```
#include <stdio.h>
#include <pthread.h>

void *thread_func(void *arg) {
    int num = *(int *)arg;
    printf("Thread received arg: %d\n", num);
    int result = num * 2;
    return (void *)(long)result;  // ë°˜í™˜ê°’ì„ void*ë¡œ ë³€í™˜
}

int main() {
    pthread_t tid;
    int arg = 10;
    void *retval;

    // ìŠ¤ë ˆë“œ ìƒì„±
    if (pthread_create(&tid, NULL, thread_func, &arg) != 0) {
        perror("pthread_create");
        return 1;
    }

    // ìŠ¤ë ˆë“œ ì¢…ë£Œê¹Œì§€ ëŒ€ê¸°
    if (pthread_join(tid, &retval) != 0) {
        perror("pthread_join");
        return 1;
    }

    printf("Thread returned: %ld\n", (long)retval);
    return 0;
}
```

#### ì‹¤í–‰ ê²°ê³¼ ì˜ˆì‹œ

```
Thread received arg: 10
Thread returned: 20
```

------

### ì£¼ì˜ì‚¬í•­

- `pthread_join()`ì„ í˜¸ì¶œí•˜ì§€ ì•Šìœ¼ë©´ í•´ë‹¹ ìŠ¤ë ˆë“œëŠ” **detached ìƒíƒœë¡œ ì „í™˜ë˜ì§€ ì•Šìœ¼ë©´ ìì› ëˆ„ìˆ˜** ë°œìƒ ê°€ëŠ¥.
- ì¼ë°˜ì ìœ¼ë¡œ **ìƒì„±í•œ ëª¨ë“  joinable threadëŠ” ë°˜ë“œì‹œ joiní•˜ê±°ë‚˜ detach** í•´ì•¼ í•¨.
- `pthread_create()`ë¡œ ìƒì„±í•œ ìŠ¤ë ˆë“œëŠ” **í”„ë¡œì„¸ìŠ¤ì™€ ë™ì¼í•œ ì£¼ì†Œ ê³µê°„**ì—ì„œ ì‹¤í–‰ë¨ â†’ ì „ì—­ ë³€ìˆ˜, í™ ë©”ëª¨ë¦¬ ê³µìœ  ì£¼ì˜ í•„ìš”.
- `pthread_join()`ì„ **ë°˜ë“œì‹œ í•œë²ˆë§Œ í˜¸ì¶œ**í•´ì•¼ í•¨. ë™ì¼í•œ ìŠ¤ë ˆë“œì— ëŒ€í•´ ì—¬ëŸ¬ ë²ˆ `pthread_join()` í˜¸ì¶œ ì‹œ undefined behavior ë°œìƒ.

------

### ì—ëŸ¬ ì²˜ë¦¬

| í•¨ìˆ˜           | ì£¼ìš” ì—ëŸ¬ ì½”ë“œ | ì˜ë¯¸                                |
| -------------- | -------------- | ----------------------------------- |
| pthread_create | EAGAIN         | ì‹œìŠ¤í…œ ìì› ë¶€ì¡± (ìŠ¤ë ˆë“œ ìƒì„± ì‹¤íŒ¨) |
| pthread_create | EINVAL         | ì˜ëª»ëœ ìŠ¤ë ˆë“œ ì†ì„±                  |
| pthread_create | EPERM          | ê¶Œí•œ ë¶€ì¡±                           |
| pthread_join   | ESRCH          | í•´ë‹¹ ìŠ¤ë ˆë“œ ì¡´ì¬í•˜ì§€ ì•ŠìŒ           |
| pthread_join   | EINVAL         | ìŠ¤ë ˆë“œê°€ joinable ìƒíƒœê°€ ì•„ë‹˜       |
| pthread_join   | EDEADLK        | êµì°© ìƒíƒœ ë°œìƒ                      |

------

### ì •ë¦¬

| ê¸°ëŠ¥             | ì‚¬ìš© í•¨ìˆ˜          |
| ---------------- | ------------------ |
| ìŠ¤ë ˆë“œ ìƒì„±      | `pthread_create()` |
| ìŠ¤ë ˆë“œ ì¢…ë£Œ ëŒ€ê¸° | `pthread_join()`   |

------

### ì‹¤ìŠµ ì•„ì´ë””ì–´

- **ë©€í‹°ìŠ¤ë ˆë“œ ì›¹ í¬ë¡¤ëŸ¬**: URL ë¦¬ìŠ¤íŠ¸ë¥¼ ì—¬ëŸ¬ ìŠ¤ë ˆë“œë¡œ ë‚˜ëˆ„ì–´ ë³‘ë ¬ ë‹¤ìš´ë¡œë“œ
- **ë³‘ë ¬ í•©ê³„ ê³„ì‚°ê¸°**: ë°°ì—´ì„ ì—¬ëŸ¬ êµ¬ê°„ìœ¼ë¡œ ë‚˜ëˆ„ì–´ ìŠ¤ë ˆë“œë³„ í•©ì‚° í›„ í†µí•©
- **ë©€í‹°ìŠ¤ë ˆë“œ ì„œë²„**: í´ë¼ì´ì–¸íŠ¸ë§ˆë‹¤ ìŠ¤ë ˆë“œ ìƒì„±í•˜ì—¬ ìš”ì²­ ì²˜ë¦¬

## 6.2 ë®¤í…ìŠ¤(`pthread_mutex_t`)

### ê°œìš”

**ë®¤í…ìŠ¤(Mutex, Mutual Exclusion)** ëŠ” **ìƒí˜¸ ë°°ì œ**ë¥¼ ì˜ë¯¸í•œë‹¤.
 ë©€í‹°ìŠ¤ë ˆë“œ í™˜ê²½ì—ì„œëŠ” **ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— ê³µìœ  ìì›**(ì „ì—­ ë³€ìˆ˜, íŒŒì¼, ë©”ëª¨ë¦¬ ë“±)ì— ì ‘ê·¼í•˜ë©´ **ê²½ìŸ ìƒíƒœ(Race Condition)** ê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.

ì´ë¥¼ ë§‰ê¸° ìœ„í•´ **ì„ê³„ ì˜ì—­(Critical Section)** ì„ ì •ì˜í•˜ê³ , í•œ ì‹œì ì— **ì˜¤ì§ í•œ ìŠ¤ë ˆë“œë§Œ** í•´ë‹¹ ì˜ì—­ì„ ì‹¤í–‰í•˜ë„ë¡ ê°•ì œí•˜ëŠ” ê²ƒì´ ë®¤í…ìŠ¤ì˜ ëª©ì ì´ë‹¤.

------

### pthread_mutex_t

POSIX ìŠ¤ë ˆë“œ ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œëŠ” **pthread_mutex_t íƒ€ì…**ì„ ì‚¬ìš©í•´ ë®¤í…ìŠ¤ë¥¼ ì œê³µí•œë‹¤.

ë®¤í…ìŠ¤ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ìƒíƒœ ì „ì´ë¥¼ ê°€ì§„ë‹¤:

```
Unlocked â†’ Locked â†’ Unlocked â†’ ...
```

í•œ ìŠ¤ë ˆë“œê°€ **Lock** í•˜ë©´ ë‹¤ë¥¸ ìŠ¤ë ˆë“œëŠ” **Block(ëŒ€ê¸°)** ìƒíƒœê°€ ë˜ë©°, Lock í•´ì œ í›„ì—ì•¼ ì ‘ê·¼ ê°€ëŠ¥í•˜ë‹¤.

------

### ì£¼ìš” í•¨ìˆ˜

#### pthread_mutex_init()

```
#include <pthread.h>

int pthread_mutex_init(pthread_mutex_t *mutex,
                       const pthread_mutexattr_t *attr);
```

- ë®¤í…ìŠ¤ ì´ˆê¸°í™”
- `attr`ëŠ” ì¼ë°˜ì ìœ¼ë¡œ `NULL` â†’ ê¸°ë³¸ ì†ì„± ì‚¬ìš©
- ë°˜í™˜ê°’: 0(ì„±ê³µ), ì—ëŸ¬ì½”ë“œ(ì‹¤íŒ¨)

#### pthread_mutex_destroy()

```
int pthread_mutex_destroy(pthread_mutex_t *mutex);
```

- ë®¤í…ìŠ¤ ì œê±°
- ë®¤í…ìŠ¤ê°€ **ì‚¬ìš© ì¤‘**ì´ë©´ undefined behavior ë°œìƒ

#### pthread_mutex_lock()

```
int pthread_mutex_lock(pthread_mutex_t *mutex);
```

- ë®¤í…ìŠ¤ë¥¼ **Lock** â†’ ì´ë¯¸ ë‹¤ë¥¸ ìŠ¤ë ˆë“œê°€ Lock ì¤‘ì´ë©´ **Block** ìƒíƒœë¡œ ëŒ€ê¸°
- ë°˜í™˜ê°’: 0(ì„±ê³µ), ì—ëŸ¬ì½”ë“œ(ì‹¤íŒ¨)

#### pthread_mutex_unlock()

```
int pthread_mutex_unlock(pthread_mutex_t *mutex);
```

- ë®¤í…ìŠ¤ë¥¼ **Unlock** â†’ ë‹¤ë¥¸ ëŒ€ê¸° ì¤‘ì¸ ìŠ¤ë ˆë“œì—ê²Œ Lock ê¶Œí•œ ë¶€ì—¬
- ë°˜í™˜ê°’: 0(ì„±ê³µ), ì—ëŸ¬ì½”ë“œ(ì‹¤íŒ¨)

#### pthread_mutex_trylock()

```
int pthread_mutex_trylock(pthread_mutex_t *mutex);
```

- ì¦‰ì‹œ Lock ì‹œë„ â†’ ì„±ê³µ ì‹œ 0 ë°˜í™˜
- ì´ë¯¸ Lock ì¤‘ì´ë©´ **ì¦‰ì‹œ EBUSY ë°˜í™˜**(Blockí•˜ì§€ ì•ŠìŒ)

------

### ê¸°ë³¸ ì˜ˆì œ

```
#include <stdio.h>
#include <pthread.h>

#define NUM_THREADS 5

pthread_mutex_t lock;
int counter = 0;

void *thread_func(void *arg) {
    int i;
    for (i = 0; i < 10000; i++) {
        pthread_mutex_lock(&lock);

        // ì„ê³„ ì˜ì—­ ì‹œì‘
        counter++;
        // ì„ê³„ ì˜ì—­ ë

        pthread_mutex_unlock(&lock);
    }
    return NULL;
}

int main() {
    pthread_t threads[NUM_THREADS];
    int i;

    pthread_mutex_init(&lock, NULL);

    for (i = 0; i < NUM_THREADS; i++) {
        pthread_create(&threads[i], NULL, thread_func, NULL);
    }

    for (i = 0; i < NUM_THREADS; i++) {
        pthread_join(threads[i], NULL);
    }

    pthread_mutex_destroy(&lock);

    printf("Final counter value: %d\n", counter);
    return 0;
}
```

#### ì‹¤í–‰ ê²°ê³¼ ì˜ˆì‹œ

```
Final counter value: 50000
```

#### ì„¤ëª…

- 5ê°œì˜ ìŠ¤ë ˆë“œê°€ `counter`ë¥¼ 1ì”© ì¦ê°€ (10000ë²ˆì”© â†’ ì´ 50000)
- **ë®¤í…ìŠ¤ ì—†ì´ ì‹¤í–‰í•˜ë©´ counter ê°’ì´ í‹€ì–´ì§** â†’ Race Condition ë°œìƒ
- **ë®¤í…ìŠ¤ ì‚¬ìš© ì‹œ ì •í™•í•œ ê²°ê³¼** ë³´ì¥

------

### ë®¤í…ìŠ¤ì˜ ì£¼ìš” íŠ¹ì§•

| íŠ¹ì§•             | ì„¤ëª…                                                         |
| ---------------- | ------------------------------------------------------------ |
| ìƒí˜¸ ë°°ì œ        | í•œ ë²ˆì— í•œ ìŠ¤ë ˆë“œë§Œ ì„ê³„ ì˜ì—­ ì ‘ê·¼ í—ˆìš©                      |
| ì¬ì§„ì… ë¶ˆê°€      | ê¸°ë³¸ ë®¤í…ìŠ¤ëŠ” ë™ì¼ ìŠ¤ë ˆë“œë¼ë„ ì¤‘ë³µ Lock ì‹œ Deadlock ë°œìƒ ê°€ëŠ¥ |
| ê³µì •ì„± ë³´ì¥ ì•„ë‹˜ | POSIX ê¸°ë³¸ ë®¤í…ìŠ¤ëŠ” ìŠ¤ë ˆë“œê°€ Lock ìš”ì²­í•œ ìˆœì„œë¥¼ ë³´ì¥í•˜ì§€ ì•ŠìŒ |
| ê²½ëŸ‰í™”           | ì»¤ë„ ì»¨í…ìŠ¤íŠ¸ ìŠ¤ìœ„ì¹­ ì—†ì´ ì‚¬ìš©ì ê³µê°„ì—ì„œ ì²˜ë¦¬ ê°€ëŠ¥ (ê²½ëŸ‰í™”ëœ ê²½ìš°) |

------

### ì‚¬ìš© íŒ¨í„´

#### ì˜¬ë°”ë¥¸ íŒ¨í„´

```
pthread_mutex_lock(&lock);
... ì„ê³„ ì˜ì—­ ...
pthread_mutex_unlock(&lock);
```

#### ì˜ëª»ëœ íŒ¨í„´

- Unlock ì—†ì´ return / exit í•˜ë©´ Lock ìƒíƒœ ìœ ì§€ â†’ Deadlock ë°œìƒ
- ë°˜ë“œì‹œ **try-finally íŒ¨í„´** ë˜ëŠ” **goto-cleanup íŒ¨í„´**ìœ¼ë¡œ ê´€ë¦¬í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤.

------

### ë®¤í…ìŠ¤ ì†ì„± (ê³ ê¸‰)

#### pthread_mutexattr_t ì‚¬ìš©

- `pthread_mutexattr_settype()` ë¡œ ë®¤í…ìŠ¤ì˜ **íƒ€ì…** ì„¤ì • ê°€ëŠ¥
- ì£¼ìš” íƒ€ì…

| íƒ€ì…                     | ì˜ë¯¸                                               |
| ------------------------ | -------------------------------------------------- |
| PTHREAD_MUTEX_NORMAL     | ê¸°ë³¸ (ì¬ê·€ì  Lock ë¶ˆê°€, Deadlock ë°œìƒ ê°€ëŠ¥)        |
| PTHREAD_MUTEX_ERRORCHECK | ì˜¤ë¥˜ ì²´í¬ ê°€ëŠ¥ (ì¤‘ë³µ Lock ì‹œ ì—ëŸ¬ ë°˜í™˜)            |
| PTHREAD_MUTEX_RECURSIVE  | ì¬ê·€ì  Lock í—ˆìš© (ë™ì¼ ìŠ¤ë ˆë“œê°€ ì—¬ëŸ¬ ë²ˆ Lock ê°€ëŠ¥) |
| PTHREAD_MUTEX_DEFAULT    | êµ¬í˜„ ì •ì˜ (ë³´í†µ NORMALê³¼ ë™ì¼)                     |

#### ì˜ˆì œ

```
pthread_mutexattr_t attr;
pthread_mutexattr_init(&attr);
pthread_mutexattr_settype(&attr, PTHREAD_MUTEX_RECURSIVE);

pthread_mutex_init(&lock, &attr);
```

------

### ë®¤í…ìŠ¤ì™€ Deadlock

#### Deadlock ë°œìƒ ì¡°ê±´ (Coffman ì¡°ê±´)

1. ìƒí˜¸ ë°°ì œ
2. ì ìœ ì™€ ëŒ€ê¸°
3. ë¹„ì„ ì 
4. ìˆœí™˜ ëŒ€ê¸°

#### Deadlock ì˜ˆë°© ì „ëµ

- **Lock ìˆœì„œ ê³ ì •**
   í•­ìƒ ë™ì¼í•œ ìˆœì„œë¡œ Lock íšë“
- **trylock ì‚¬ìš© í›„ Backoff**
- **Timeout ê¸°ë°˜ Lock ì‹œë„**

------

### ì •ë¦¬

| ë™ì‘             | í•¨ìˆ˜                      |
| ---------------- | ------------------------- |
| ì´ˆê¸°í™”           | `pthread_mutex_init()`    |
| ì œê±°             | `pthread_mutex_destroy()` |
| Lock             | `pthread_mutex_lock()`    |
| Unlock           | `pthread_mutex_unlock()`  |
| ë¹„ì°¨ë‹¨ Lock ì‹œë„ | `pthread_mutex_trylock()` |

------

### ì‹¤ìŠµ ì•„ì´ë””ì–´

- **ì€í–‰ ê³„ì¢Œ ì‹œë®¬ë ˆì´í„°**: ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ ì…ê¸ˆ/ì¶œê¸ˆ ì‘ì—… â†’ ë®¤í…ìŠ¤ ì—†ì´ ì‹¤í–‰ ì‹œ ì˜¤ë¥˜ ë°œìƒ
- **ë©€í‹°ìŠ¤ë ˆë“œ ë¡œê·¸ íŒŒì¼ ê¸°ë¡ê¸°**: ë®¤í…ìŠ¤ ì—†ì´ ë¡œê·¸ íŒŒì¼ ê¸°ë¡ ì‹œ ê¼¬ì„ ë°œìƒ â†’ ë®¤í…ìŠ¤ë¡œ ë³´í˜¸
- **ìƒì‚°ì-ì†Œë¹„ì ë¬¸ì œ (ë‹¤ìŒ 6.3ê³¼ ì—°ê³„)**: íì— ëŒ€í•œ Push/Pop ì‹œ ë®¤í…ìŠ¤ë¡œ ë³´í˜¸

## 6.3 ì¡°ê±´ ë³€ìˆ˜, `pthread_cond_t`

### ê°œìš”

ë©€í‹°ìŠ¤ë ˆë“œ í™˜ê²½ì—ì„œëŠ” ì¢…ì¢… **íŠ¹ì • ì¡°ê±´ì´ ë§Œì¡±ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ëŠ”** ë™ê¸°í™” íŒ¨í„´ì´ í•„ìš”í•˜ë‹¤.

- ë®¤í…ìŠ¤ëŠ” **ìƒí˜¸ ë°°ì œ**ë§Œ ë³´ì¥í•œë‹¤.
- ì¡°ê±´ ë³€ìˆ˜(Condition Variable)ëŠ” **ìƒíƒœ ë³€í™” ì¡°ê±´**ì„ ê¸°ë‹¤ë ¸ë‹¤ê°€ ì¡°ê±´ì´ ë§Œì¡±ë˜ë©´ ë‹¤ë¥¸ ìŠ¤ë ˆë“œë¥¼ ê¹¨ìš°ëŠ” ìš©ë„ë¡œ ì‚¬ìš©ëœë‹¤.

**ì¡°ê±´ ë³€ìˆ˜ + ë®¤í…ìŠ¤**ëŠ” **ê³ ì „ì  ë™ê¸°í™” íŒ¨í„´**(ìƒì‚°ì-ì†Œë¹„ì ë¬¸ì œ ë“±)ì„ êµ¬í˜„í•  ë•Œ í•µì‹¬ì ì´ë‹¤.

------

### ì¡°ê±´ ë³€ìˆ˜ì™€ ì„ê³„ ì˜ì—­

ì¡°ê±´ ë³€ìˆ˜ëŠ” ìì²´ì ìœ¼ë¡œ **ìƒí˜¸ ë°°ì œë¥¼ ì œê³µí•˜ì§€ ì•ŠëŠ”ë‹¤.**
 ë”°ë¼ì„œ í•­ìƒ **ë®¤í…ìŠ¤ì™€ í•¨ê»˜ ì‚¬ìš©**í•´ì•¼ í•œë‹¤.

íŒ¨í„´:

```
pthread_mutex_lock(&mutex);
while (ì¡°ê±´ì´ ë§Œì¡±ë˜ì§€ ì•ŠìŒ) {
    pthread_cond_wait(&cond, &mutex);
}
... ì¡°ê±´ì´ ë§Œì¡±ëœ ìƒíƒœì—ì„œ ì‘ì—… ìˆ˜í–‰ ...
pthread_mutex_unlock(&mutex);
```

------

### ì£¼ìš” í•¨ìˆ˜

#### pthread_cond_init()

```
#include <pthread.h>

int pthread_cond_init(pthread_cond_t *cond,
                      const pthread_condattr_t *attr);
```

- ì¡°ê±´ ë³€ìˆ˜ ì´ˆê¸°í™”
- `attr`ëŠ” ì¼ë°˜ì ìœ¼ë¡œ `NULL` ì‚¬ìš©
- ë°˜í™˜ê°’: 0(ì„±ê³µ), ì—ëŸ¬ì½”ë“œ(ì‹¤íŒ¨)

#### pthread_cond_destroy()

```
int pthread_cond_destroy(pthread_cond_t *cond);
```

- ì¡°ê±´ ë³€ìˆ˜ ì œê±°

#### pthread_cond_wait()

```
int pthread_cond_wait(pthread_cond_t *cond,
                      pthread_mutex_t *mutex);
```

- í˜¸ì¶œ ìŠ¤ë ˆë“œëŠ” `mutex`ë¥¼ ì ê·¼ ìƒíƒœì—¬ì•¼ í•¨.
- í•¨ìˆ˜ëŠ” ë‹¤ìŒì„ ìˆ˜í–‰:
  1. `mutex`ë¥¼ **ìë™ìœ¼ë¡œ Unlock**.
  2. ì¡°ê±´ ë³€ìˆ˜ê°€ signal/broadcastë  ë•Œê¹Œì§€ **Block** ìƒíƒœë¡œ ëŒ€ê¸°.
  3. ê¹¨ìš´ í›„ ë‹¤ì‹œ `mutex`ë¥¼ **Lock** í•œ ìƒíƒœë¡œ ë³µê·€.

#### pthread_cond_signal()

```
int pthread_cond_signal(pthread_cond_t *cond);
```

- ì¡°ê±´ ë³€ìˆ˜ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ìŠ¤ë ˆë“œ ì¤‘ **í•˜ë‚˜**ë¥¼ ê¹¨ì›€.

#### pthread_cond_broadcast()

```
int pthread_cond_broadcast(pthread_cond_t *cond);
```

- ì¡°ê±´ ë³€ìˆ˜ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” **ëª¨ë“ ** ìŠ¤ë ˆë“œë¥¼ ê¹¨ì›€.

------

### ê¸°ë³¸ ì˜ˆì œ

**ìƒì‚°ì-ì†Œë¹„ì ë¬¸ì œ (ë‹¨ìˆœ ë²„ì „)**

```
#include <stdio.h>
#include <pthread.h>
#include <unistd.h>

pthread_mutex_t lock;
pthread_cond_t cond;
int data_ready = 0;

void *producer(void *arg) {
    sleep(1); // ë°ì´í„° ìƒì„± ì§€ì—° ì‹œë®¬ë ˆì´ì…˜
    pthread_mutex_lock(&lock);
    data_ready = 1;
    printf("Producer: data ready, signaling consumer\n");
    pthread_cond_signal(&cond);
    pthread_mutex_unlock(&lock);
    return NULL;
}

void *consumer(void *arg) {
    pthread_mutex_lock(&lock);
    while (data_ready == 0) {
        printf("Consumer: waiting for data\n");
        pthread_cond_wait(&cond, &lock);
    }
    printf("Consumer: data received, processing\n");
    pthread_mutex_unlock(&lock);
    return NULL;
}

int main() {
    pthread_t prod_thread, cons_thread;

    pthread_mutex_init(&lock, NULL);
    pthread_cond_init(&cond, NULL);

    pthread_create(&cons_thread, NULL, consumer, NULL);
    pthread_create(&prod_thread, NULL, producer, NULL);

    pthread_join(prod_thread, NULL);
    pthread_join(cons_thread, NULL);

    pthread_cond_destroy(&cond);
    pthread_mutex_destroy(&lock);

    return 0;
}
```

#### ì‹¤í–‰ ì˜ˆì‹œ

```
Consumer: waiting for data
Producer: data ready, signaling consumer
Consumer: data received, processing
```

------

### ì‚¬ìš© íŒ¨í„´

#### ì™œ while ë£¨í”„ë¥¼ ì“°ëŠ”ê°€?

```
while (ì¡°ê±´ì´ ë§Œì¡±ë˜ì§€ ì•ŠìŒ) {
    pthread_cond_wait(&cond, &mutex);
}
```

ì´ìœ :

- **Spurious wakeup** (ê°€ì§œ ê¹¨ì›€) ê°€ëŠ¥ì„± ì¡´ì¬ â†’ ë°˜ë“œì‹œ **ì¡°ê±´ì„ ì¬í™•ì¸**í•´ì•¼ ì•ˆì „í•˜ë‹¤.
- ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ ëŒ€ê¸° ì¤‘ì¼ ë•Œ íŠ¹ì • ìŠ¤ë ˆë“œê°€ ì‹ í˜¸ë¥¼ ë°›ì•˜ë”ë¼ë„ ì¡°ê±´ì´ ì´ë¯¸ ë‹¤ë¥¸ ìŠ¤ë ˆë“œì— ì˜í•´ ë³€ê²½ëì„ ìˆ˜ ìˆë‹¤.

#### Signal vs Broadcast

| í•¨ìˆ˜                     | íš¨ê³¼                        |
| ------------------------ | --------------------------- |
| pthread_cond_signal()    | **í•˜ë‚˜**ì˜ ëŒ€ê¸° ìŠ¤ë ˆë“œ ê¹¨ì›€ |
| pthread_cond_broadcast() | **ëª¨ë“ ** ëŒ€ê¸° ìŠ¤ë ˆë“œ ê¹¨ì›€   |

ì¼ë°˜ì ìœ¼ë¡œ:

- ë‹¨ì¼ ì†Œë¹„ì â†’ `pthread_cond_signal()`
- ë‹¤ìˆ˜ ì†Œë¹„ì â†’ `pthread_cond_broadcast()` ê³ ë ¤

------

### Deadlock ë°©ì§€

- ë°˜ë“œì‹œ **ë®¤í…ìŠ¤ ì ê¸ˆ ìƒíƒœ**ì—ì„œ `pthread_cond_wait()` í˜¸ì¶œ
- ì¡°ê±´ ë³€ìˆ˜ ëŒ€ê¸° ì „í›„ë¡œ **ë®¤í…ìŠ¤ í•´ì œ/íšë“ íŒ¨í„´ì„ ì •í™•íˆ ì¤€ìˆ˜**í•´ì•¼ Deadlockì„ ì˜ˆë°©í•  ìˆ˜ ìˆë‹¤.

------

### ì •ë¦¬

| ë™ì‘        | í•¨ìˆ˜                       |
| ----------- | -------------------------- |
| ì´ˆê¸°í™”      | `pthread_cond_init()`      |
| ì œê±°        | `pthread_cond_destroy()`   |
| ëŒ€ê¸°        | `pthread_cond_wait()`      |
| ì‹ í˜¸ ë³´ë‚´ê¸° | `pthread_cond_signal()`    |
| ì „ì²´ ê¹¨ìš°ê¸° | `pthread_cond_broadcast()` |

------

### ì‹¤ìŠµ ì•„ì´ë””ì–´

- **ìƒì‚°ì-ì†Œë¹„ì ë¬¸ì œ í™•ì¥** â†’ Circular Queue êµ¬í˜„ + ë‹¤ìˆ˜ ìƒì‚°ì/ì†Œë¹„ì
- **Barrier(ì¥ë²½) êµ¬í˜„** â†’ ëª¨ë“  ìŠ¤ë ˆë“œê°€ íŠ¹ì • ì‹œì ê¹Œì§€ ëŒ€ê¸° â†’ ì¡°ê±´ ë§Œì¡± ì‹œ ë™ì‹œì— ì§„í–‰
- **Thread Pool ì‘ì—… ëŒ€ê¸° í** â†’ ì‘ì—… ì—†ì„ ë•Œ ì¡°ê±´ ë³€ìˆ˜ë¡œ ëŒ€ê¸°

------

### ê³ ê¸‰: ì‹œê°„ì œí•œ ëŒ€ê¸°

#### pthread_cond_timedwait()

```
int pthread_cond_timedwait(pthread_cond_t *cond,
                           pthread_mutex_t *mutex,
                           const struct timespec *abstime);
```

- íŠ¹ì • ì‹œê°„ê¹Œì§€ë§Œ ì¡°ê±´ ë³€ìˆ˜ ëŒ€ê¸°
- íƒ€ì„ì•„ì›ƒ ë°œìƒ ì‹œ `ETIMEDOUT` ë°˜í™˜

í™œìš© ì˜ˆ:

- **ì„œë²„ timeout ì²˜ë¦¬**
- **UI ì‘ë‹µì„± ê°œì„ **

## 6.4 ë°ë“œë½/ê²½ìŸ ì¡°ê±´ ì‹œë®¬ë ˆì´ì…˜

### ê°œìš”

ë©€í‹°ìŠ¤ë ˆë“œ/ë©€í‹°í”„ë¡œì„¸ìŠ¤ í™˜ê²½ì—ì„œëŠ” **ë™ê¸°í™” ë¬¸ì œ**ê°€ ê°€ì¥ í° ì„¤ê³„/êµ¬í˜„ìƒì˜ ì–´ë ¤ì›€ì´ë‹¤.
 ëŒ€í‘œì  ë¬¸ì œëŠ”:

- **Race Condition (ê²½ìŸ ì¡°ê±´)**: ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ ë™ì‹œ ì ‘ê·¼ ì‹œ ì˜ˆìƒì¹˜ ëª»í•œ ê²°ê³¼ ë°œìƒ
- **Deadlock (êµì°© ìƒíƒœ)**: ë‘ ê°œ ì´ìƒì˜ ìŠ¤ë ˆë“œê°€ ì„œë¡œ Lockì„ ê¸°ë‹¤ë¦¬ë©° ì˜ì›íˆ Block ìƒíƒœê°€ ë˜ëŠ” ë¬¸ì œ

ì´ë“¤ì€ ëª¨ë‘ **ì˜ëª»ëœ ë™ê¸°í™” ì„¤ê³„**ì—ì„œ ë°œìƒí•œë‹¤.

------

### 1ï¸âƒ£ Race Condition (ê²½ìŸ ì¡°ê±´)

#### ê°œë…

- Race Conditionì€ **íƒ€ì´ë°ì— ì˜ì¡´í•œ ì˜¤ë¥˜**ë‹¤.
- ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ **ì„ê³„ ì˜ì—­ ë³´í˜¸ ì—†ì´** ê³µìœ  ìì›ì— ì ‘ê·¼ ì‹œ ë°œìƒí•œë‹¤.

#### ì¦ìƒ

- ë°ì´í„° ì†ìƒ
- ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥í•œ ì‹¤í–‰ ê²°ê³¼
- ì‹¤í–‰ ì‹œë§ˆë‹¤ ë‹¤ë¥¸ ê²°ê³¼ ë°œìƒ

#### ì˜ˆì œ

**ë®¤í…ìŠ¤ ì—†ì´ counter ì¦ê°€**

```
#include <stdio.h>
#include <pthread.h>

#define NUM_THREADS 5
#define NUM_INCREMENTS 100000

int counter = 0;  // ê³µìœ  ë³€ìˆ˜

void *thread_func(void *arg) {
    for (int i = 0; i < NUM_INCREMENTS; i++) {
        counter++;  // ê²½ìŸ ë°œìƒ
    }
    return NULL;
}

int main() {
    pthread_t threads[NUM_THREADS];

    for (int i = 0; i < NUM_THREADS; i++) {
        pthread_create(&threads[i], NULL, thread_func, NULL);
    }

    for (int i = 0; i < NUM_THREADS; i++) {
        pthread_join(threads[i], NULL);
    }

    printf("Final counter value: %d\n", counter);
    return 0;
}
```

#### ì‹¤í–‰ ê²°ê³¼ ì˜ˆì‹œ

```
Final counter value: 423598
(ê¸°ëŒ€ê°’ì€ 5 * 100000 = 500000)
```

â†’ ë§¤ë²ˆ ì‹¤í–‰ ì‹œ ê²°ê³¼ê°€ ë‹¤ë¥´ê²Œ ë‚˜ì˜¨ë‹¤ â†’ **Race Condition ë°œìƒ**

------

### 2ï¸âƒ£ Deadlock (êµì°© ìƒíƒœ)

#### ê°œë…

- Deadlockì€ **ìŠ¤ë ˆë“œë“¤ì´ ì„œë¡œê°€ ì†Œìœ í•œ Lockì„ ê¸°ë‹¤ë¦¬ëŠ” ìƒí™©**ì´ë‹¤.
- ì¡°ê±´:
  - ìƒí˜¸ ë°°ì œ
  - ì ìœ ì™€ ëŒ€ê¸°
  - ë¹„ì„ ì 
  - ìˆœí™˜ ëŒ€ê¸°

#### ì¦ìƒ

- í”„ë¡œê·¸ë¨ì´ **ë©ˆì¶¤(Hang)**
- CPU ì‚¬ìš©ëŸ‰ ê°ì†Œ / ìŠ¤ë ˆë“œê°€ ì˜ì›íˆ Block ìƒíƒœ

#### ì˜ˆì œ

**Lock ìˆœì„œ ë°˜ì „ìœ¼ë¡œ Deadlock ë°œìƒ**

```
#include <stdio.h>
#include <pthread.h>
#include <unistd.h>

pthread_mutex_t lock1;
pthread_mutex_t lock2;

void *thread1_func(void *arg) {
    pthread_mutex_lock(&lock1);
    printf("Thread 1 acquired lock1\n");
    sleep(1);  // Deadlock ìœ ë„

    pthread_mutex_lock(&lock2);
    printf("Thread 1 acquired lock2\n");

    pthread_mutex_unlock(&lock2);
    pthread_mutex_unlock(&lock1);
    return NULL;
}

void *thread2_func(void *arg) {
    pthread_mutex_lock(&lock2);
    printf("Thread 2 acquired lock2\n");
    sleep(1);  // Deadlock ìœ ë„

    pthread_mutex_lock(&lock1);
    printf("Thread 2 acquired lock1\n");

    pthread_mutex_unlock(&lock1);
    pthread_mutex_unlock(&lock2);
    return NULL;
}

int main() {
    pthread_t t1, t2;

    pthread_mutex_init(&lock1, NULL);
    pthread_mutex_init(&lock2, NULL);

    pthread_create(&t1, NULL, thread1_func, NULL);
    pthread_create(&t2, NULL, thread2_func, NULL);

    pthread_join(t1, NULL);
    pthread_join(t2, NULL);

    pthread_mutex_destroy(&lock1);
    pthread_mutex_destroy(&lock2);

    return 0;
}
```

#### ì‹¤í–‰ ê²°ê³¼ ì˜ˆì‹œ

```
Thread 1 acquired lock1
Thread 2 acquired lock2
(ì´í›„ ë©ˆì¶¤ - Deadlock ë°œìƒ)
```

â†’ ë‘ ìŠ¤ë ˆë“œê°€ ì„œë¡œê°€ ê°€ì§„ Lockì„ ê¸°ë‹¤ë¦¬ë©° ì˜ì›íˆ Block â†’ **Deadlock ë°œìƒ**

------

### Deadlock ì˜ˆë°© ì „ëµ

| ì „ëµ           | ì„¤ëª…                                                         |
| -------------- | ------------------------------------------------------------ |
| Lock ìˆœì„œ ê³ ì • | í•­ìƒ ë™ì¼í•œ ìˆœì„œë¡œ Lock íšë“                                 |
| Try-lock ì‚¬ìš©  | `pthread_mutex_trylock()`ìœ¼ë¡œ ì‹¤íŒ¨ ì‹œ Backoff                |
| íƒ€ì„ì•„ì›ƒ ì‚¬ìš©  | `pthread_mutex_timedlock()` ë˜ëŠ” `pthread_cond_timedwait()` í™œìš© |
| Lock ë¶„í•´ ì„¤ê³„ | ê°€ëŠ¥í•œ í•œ Lock ì‚¬ìš© ë²”ìœ„ë¥¼ ìµœì†Œí™”                            |

#### ì•ˆì „í•œ Lock ìˆœì„œ ì˜ˆì‹œ

```
pthread_mutex_lock(&lock1);
pthread_mutex_lock(&lock2);

... ì‘ì—… ìˆ˜í–‰ ...

pthread_mutex_unlock(&lock2);
pthread_mutex_unlock(&lock1);
```

**ëª¨ë“  ìŠ¤ë ˆë“œì—ì„œ ë™ì¼í•œ ìˆœì„œë¡œ lock1 â†’ lock2 ì‚¬ìš©** â†’ Deadlock ë°œìƒ ë°©ì§€

------

### ê²½ìŸ ì¡°ê±´ í•´ê²°

- ë°˜ë“œì‹œ **ë®¤í…ìŠ¤ ë˜ëŠ” ì›ìì  ì—°ì‚°**ìœ¼ë¡œ ì„ê³„ ì˜ì—­ ë³´í˜¸ í•„ìš”
- ì˜ˆì‹œ:

```
pthread_mutex_lock(&lock);
counter++;
pthread_mutex_unlock(&lock);
```

ë˜ëŠ”

```
__sync_fetch_and_add(&counter, 1);  // GCC ì›ìì  ì—°ì‚° built-in
```

------

### ì •ë¦¬

| ë¬¸ì œ           | ë°œìƒ ì›ì¸                      | ì¦ìƒ                       | í•´ê²° ë°©ë²•                                   |
| -------------- | ------------------------------ | -------------------------- | ------------------------------------------- |
| Race Condition | ë³´í˜¸ë˜ì§€ ì•Šì€ ì„ê³„ ì˜ì—­        | ë°ì´í„° ì†ìƒ, ë¶ˆì•ˆì •í•œ ê²°ê³¼ | ë®¤í…ìŠ¤ ë˜ëŠ” ì›ìì  ì—°ì‚° ì‚¬ìš©                |
| Deadlock       | Lock ìˆœì„œ ë°˜ì „, ìˆœí™˜ ëŒ€ê¸° ë°œìƒ | í”„ë¡œê·¸ë¨ ë©ˆì¶¤, Hang        | Lock ìˆœì„œ ê³ ì •, Trylock ì‚¬ìš©, íƒ€ì„ì•„ì›ƒ ë„ì… |

------

### ì‹¤ìŠµ ì•„ì´ë””ì–´

- ê²½ìŸ ì¡°ê±´: ì—¬ëŸ¬ ìŠ¤ë ˆë“œë¡œ Bank Account ì…ê¸ˆ/ì¶œê¸ˆ ì‹œë®¬ë ˆì´ì…˜ â†’ Lock ìœ ë¬´ ë¹„êµ ì‹¤í—˜
- Deadlock: 3ê°œ ì´ìƒì˜ Lockì„ ìˆœì„œ ì—†ì´ íšë“í•˜ëŠ” ì½”ë“œ â†’ Deadlock ë°œìƒ í™•ì¸
- Deadlock ì˜ˆë°©: Trylockìœ¼ë¡œ Backoff êµ¬í˜„

## 6.5 CPU ë°”ì¸ë”© (`sched_setaffinity()`)

### ê°œìš”

ë©€í‹°ì½”ì–´ CPU í™˜ê²½ì—ì„œëŠ” **ìŠ¤ë ˆë“œ/í”„ë¡œì„¸ìŠ¤ë¥¼ íŠ¹ì • CPU ì½”ì–´ì— ê³ ì •(ë°”ì¸ë”©, Pinning)** í•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•˜ë‹¤.
 ì´ ê¸°ëŠ¥ì„ **CPU affinity(affinity = ì¹œí™”ë„, ê³ ì •)** ë¼ê³  ë¶€ë¥¸ë‹¤.

`cpu affinity`ë¥¼ ì‚¬ìš©í•˜ë©´:

- **ìºì‹œ íš¨ìœ¨ì„±** ì¦ê°€
   ìŠ¤ë ˆë“œê°€ ë™ì¼ ì½”ì–´ì—ì„œ ë°˜ë³µ ì‹¤í–‰ ì‹œ **CPU cache locality** í–¥ìƒ
- **íŠ¹ì • ì½”ì–´ ì „ìš© ì‘ì—… ì‹¤í–‰**
   ì‹¤ì‹œê°„ ì²˜ë¦¬ë‚˜ ê³ ìš°ì„ ìˆœìœ„ ì‘ì—…ì„ íŠ¹ì • ì½”ì–´ì— ê³ ì • ê°€ëŠ¥
- **ì„±ëŠ¥ íŠœë‹**
   NUMA ì•„í‚¤í…ì²˜ì—ì„œ ë©”ëª¨ë¦¬ ì ‘ê·¼ íš¨ìœ¨ í–¥ìƒ

Linuxì—ì„œëŠ” **`sched_setaffinity()`** ì™€ **`sched_getaffinity()`** ì‹œìŠ¤í…œ ì½œë¡œ êµ¬í˜„ëœë‹¤.

------

### sched_setaffinity()

#### í•¨ìˆ˜ ì›í˜•

```
#define _GNU_SOURCE
#include <sched.h>

int sched_setaffinity(pid_t pid,
                      size_t cpusetsize,
                      const cpu_set_t *mask);
```

#### ë§¤ê°œë³€ìˆ˜ ì„¤ëª…

| ë§¤ê°œë³€ìˆ˜     | ì„¤ëª…                                                         |
| ------------ | ------------------------------------------------------------ |
| `pid`        | ëŒ€ìƒ í”„ë¡œì„¸ìŠ¤/ìŠ¤ë ˆë“œ ID 0 â†’ í˜¸ì¶œí•œ ìì‹  (`getpid()` or `gettid()` ì‚¬ìš© ê°€ëŠ¥) |
| `cpusetsize` | CPU ì…‹ì˜ í¬ê¸° (ë³´í†µ `sizeof(cpu_set_t)`)                     |
| `mask`       | ì–´ë–¤ CPUì— ë°”ì¸ë”©í• ì§€ ì§€ì •í•œ ë§ˆìŠ¤í¬ (`cpu_set_t` íƒ€ì…)       |

#### ë°˜í™˜ê°’

- `0` â†’ ì„±ê³µ
- `-1` â†’ ì‹¤íŒ¨ (`errno` ì„¤ì •ë¨)

------

### CPU_SET ë§¤í¬ë¡œ

Linuxì—ì„œëŠ” `cpu_set_t` ë¼ëŠ” CPU ì§‘í•© êµ¬ì¡°ì²´ë¥¼ ì‚¬ìš©í•˜ë©°, ë‹¤ìŒê³¼ ê°™ì€ ë§¤í¬ë¡œë¡œ ì¡°ì‘í•œë‹¤:

| ë§¤í¬ë¡œ                 | ì„¤ëª…                                  |
| ---------------------- | ------------------------------------- |
| `CPU_ZERO(&set)`       | CPU ì§‘í•© ì´ˆê¸°í™” (ë¹„ì›€)                |
| `CPU_SET(cpu, &set)`   | íŠ¹ì • CPUë¥¼ setì— ì¶”ê°€                 |
| `CPU_CLR(cpu, &set)`   | íŠ¹ì • CPUë¥¼ setì—ì„œ ì œê±°               |
| `CPU_ISSET(cpu, &set)` | íŠ¹ì • CPUê°€ setì— í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸ |

------

### sched_getaffinity()

#### í•¨ìˆ˜ ì›í˜•

```
#define _GNU_SOURCE
#include <sched.h>

int sched_getaffinity(pid_t pid,
                      size_t cpusetsize,
                      cpu_set_t *mask);
```

- í˜„ì¬ í”„ë¡œì„¸ìŠ¤/ìŠ¤ë ˆë“œì˜ CPU affinityë¥¼ ì½ì–´ì˜´
- ë°˜í™˜ê°’ ë° ì‚¬ìš©ë²•ì€ `sched_setaffinity()` ì™€ ë™ì¼

------

### ê¸°ë³¸ ì˜ˆì œ

```
#define _GNU_SOURCE
#include <stdio.h>
#include <sched.h>
#include <unistd.h>

int main() {
    cpu_set_t set;
    int cpu;

    // í˜„ì¬ í”„ë¡œì„¸ìŠ¤ì˜ CPU affinity ì¡°íšŒ
    CPU_ZERO(&set);
    if (sched_getaffinity(0, sizeof(set), &set) == -1) {
        perror("sched_getaffinity");
        return 1;
    }

    printf("Current CPU affinity: ");
    for (cpu = 0; cpu < CPU_SETSIZE; cpu++) {
        if (CPU_ISSET(cpu, &set))
            printf("%d ", cpu);
    }
    printf("\n");

    // CPU affinity ì„¤ì •: CPU 0ë²ˆë§Œ ì‚¬ìš©í•˜ë„ë¡ ê³ ì •
    CPU_ZERO(&set);
    CPU_SET(0, &set);

    if (sched_setaffinity(0, sizeof(set), &set) == -1) {
        perror("sched_setaffinity");
        return 1;
    }

    printf("CPU affinity set to CPU 0\n");

    while (1) {
        // CPU 0ì—ì„œ ë¬´í•œ ë£¨í”„ ì‹¤í–‰
    }

    return 0;
}
```

#### ì‹¤í–‰ ê²°ê³¼ ì˜ˆì‹œ

```
Current CPU affinity: 0 1 2 3
CPU affinity set to CPU 0
```

â†’ ì´í›„ í”„ë¡œì„¸ìŠ¤ëŠ” **CPU 0ì—ì„œë§Œ ì‹¤í–‰**ë¨ â†’ ë‹¤ë¥¸ CPUë¡œ ìŠ¤ì¼€ì¤„ë§ë˜ì§€ ì•ŠìŒ.

------

### ë©€í‹°ìŠ¤ë ˆë“œì—ì„œ ì‚¬ìš©

ìŠ¤ë ˆë“œ ë³„ affinity ì„¤ì •:

- Linuxì—ì„œëŠ” **ìŠ¤ë ˆë“œë§ˆë‹¤ ë…ë¦½ì ì¸ affinity ì„¤ì • ê°€ëŠ¥**í•˜ë‹¤.
- `pthread_self()` â†’ `gettid()` í•„ìš”:
  - Linuxì˜ **ìŠ¤ë ˆë“œ IDëŠ” `gettid()`ë¡œ êµ¬í•´ì•¼ ì •í™•í•¨** â†’ `getpid()`ëŠ” ì „ì²´ í”„ë¡œì„¸ìŠ¤ì˜ PID ë°˜í™˜.

```
#define _GNU_SOURCE
#include <stdio.h>
#include <pthread.h>
#include <unistd.h>
#include <sched.h>
#include <sys/syscall.h>

#define gettid() syscall(SYS_gettid)

void *thread_func(void *arg) {
    cpu_set_t set;
    CPU_ZERO(&set);
    CPU_SET(1, &set);  // CPU 1ë¡œ ê³ ì •

    if (sched_setaffinity(gettid(), sizeof(set), &set) == -1) {
        perror("sched_setaffinity");
        return NULL;
    }

    while (1) {
        // CPU 1ì—ì„œ ë°˜ë³µ ì‹¤í–‰
    }

    return NULL;
}

int main() {
    pthread_t thread;

    pthread_create(&thread, NULL, thread_func, NULL);

    pthread_join(thread, NULL);

    return 0;
}
```

â†’ ìœ„ ì˜ˆì œì—ì„œ ìŠ¤ë ˆë“œëŠ” **CPU 1ë¡œ ê³ ì •**ë˜ì–´ ì‹¤í–‰ëœë‹¤.

------

### ì£¼ì˜ì‚¬í•­

- í”„ë¡œì„¸ìŠ¤/ìŠ¤ë ˆë“œ affinityëŠ” **ì»¤ë„ ìŠ¤ì¼€ì¤„ëŸ¬ íŒíŠ¸**ì¼ ë¿ â†’ ê°•ì œì  ì™„ì „ ê³ ì •ì€ ì•„ë‹˜ (ì‹œê·¸ë„ í•¸ë“¤ë§ ë“±ìœ¼ë¡œ ì´ë™ ê°€ëŠ¥ì„± ì¡´ì¬).
- **NUMA ì‹œìŠ¤í…œ**ì—ì„œëŠ” CPU affinityì™€ **ë©”ëª¨ë¦¬ affinity**ë„ ê°™ì´ ê³ ë ¤í•´ì•¼ ìµœì  ì„±ëŠ¥ ê°€ëŠ¥.
- **ì˜ëª»ëœ affinity ì„¤ì •**(ì˜ˆ: ëª¨ë“  ìŠ¤ë ˆë“œë¥¼ CPU 0ìœ¼ë¡œ ê³ ì •)ì€ ì„±ëŠ¥ ì €í•˜ë¥¼ ìœ ë°œí•  ìˆ˜ ìˆë‹¤.
- affinity ì„¤ì •ì€ **ì‹¤ì‹œê°„ ì‹œìŠ¤í…œ, ê³ ì„±ëŠ¥ ë„¤íŠ¸ì›Œí¬ ì²˜ë¦¬, ë°ì´í„°ë² ì´ìŠ¤ íŠœë‹** ë“±ì—ì„œ ìœ ìš©í•˜ë‹¤.

------

### ì •ë¦¬

| ê¸°ëŠ¥              | í•¨ìˆ˜                                                  |
| ----------------- | ----------------------------------------------------- |
| CPU affinity ì„¤ì • | `sched_setaffinity()`                                 |
| CPU affinity ì¡°íšŒ | `sched_getaffinity()`                                 |
| CPU set ê´€ë¦¬      | `CPU_ZERO()`, `CPU_SET()`, `CPU_CLR()`, `CPU_ISSET()` |

------

### ì‹¤ìŠµ ì•„ì´ë””ì–´

- **ë©€í‹°ìŠ¤ë ˆë“œ ì„œë²„ ì„±ëŠ¥ íŠœë‹**: íŠ¹ì • ìŠ¤ë ˆë“œë¥¼ ê³ ì • CPUì— ë°”ì¸ë”© â†’ **ìŠ¤ë ˆë“œê°„ ìºì‹œ ê²½í•©(Cache Thrashing) ê°ì†Œ**
- **ì‹¤ì‹œê°„ ë¯¸ë””ì–´ ì²˜ë¦¬ ìŠ¤ë ˆë“œ**ë§Œ ê³ ì • CPU í• ë‹¹ â†’ latency ê°ì†Œ
- **ë©€í‹°í NIC(Network Interface Card)** â†’ IRQ affinityì™€ ì—°ê³„í•œ CPU affinity íŠœë‹

# ğŸ“ ì‹¤ìŠµ

## ë‹¤ì¤‘ ì“°ë ˆë“œ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹œë®¬ë ˆì´í„°

### ëª©í‘œ

ë©€í‹°ìŠ¤ë ˆë“œ í”„ë¡œê·¸ë˜ë°ì—ì„œ ìì£¼ ë“±ì¥í•˜ëŠ” íŒ¨í„´ ì¤‘ í•˜ë‚˜ê°€ **íŒŒì¼ì„ ì—¬ëŸ¬ ë¶€ë¶„ìœ¼ë¡œ ë‚˜ëˆ„ì–´ ë™ì‹œì— ë‹¤ìš´ë¡œë“œ**í•˜ëŠ” ê²ƒì´ë‹¤.
 ì‹¤ì œ HTTP Range ìš”ì²­ê³¼ëŠ” ë‹¤ë¥´ì§€ë§Œ, ì—¬ê¸°ì„œëŠ” **íŒŒì¼ì„ ë¸”ë¡ ë‹¨ìœ„ë¡œ ë‚˜ëˆ„ì–´ ë™ì‹œì— ì½ì–´ì™€ ë³‘í•©**í•˜ëŠ” í˜•íƒœì˜ **ì‹œë®¬ë ˆì´í„°**ë¥¼ C ì–¸ì–´ë¡œ êµ¬í˜„í•´ë³´ì.

- ê° ì“°ë ˆë“œëŠ” **íŒŒì¼ì˜ ì¼ë¶€ë¶„**ë§Œ ì½ëŠ”ë‹¤.
- ì“°ë ˆë“œëŠ” í•´ë‹¹ ë¸”ë¡ì„ **ê³µìœ  ë²„í¼ì— ê¸°ë¡**í•œë‹¤.
- ìµœì¢…ì ìœ¼ë¡œ ì „ì²´ íŒŒì¼ì´ ë³‘í•©ëœë‹¤.

------

### êµ¬ì¡°

```
+------------+------------+------------+------------+
|  Thread 1  |  Thread 2  |  Thread 3  |  Thread N  |
+------------+------------+------------+------------+
        \           \            \           \
         \           \            \           \
          +-------- Shared Buffer / Output File --------+
```

- **Mutex** ì‚¬ìš©: ì—¬ëŸ¬ ì“°ë ˆë“œê°€ ê³µìœ  ë²„í¼ë‚˜ ì¶œë ¥ íŒŒì¼ì— ë™ì‹œì— ì ‘ê·¼í•˜ì§€ ì•Šë„ë¡ ë³´í˜¸
- **ì¡°ê±´ ë³€ìˆ˜(ì˜µì…˜)**: íŠ¹ì • ìƒí™©ì—ì„œëŠ” ì“°ë ˆë“œê°„ ë™ê¸°í™”ë„ ê°€ëŠ¥

------

### ì˜ˆì œ ì½”ë“œ (ë‹¨ì¼ íŒŒì¼, ì—¬ëŸ¬ ë¸”ë¡ ì½ê¸° ì‹œë®¬ë ˆì´í„°)

#### ì „ì œ

- `input.dat`ë¼ëŠ” íŒŒì¼ì´ ìˆë‹¤ê³  ê°€ì •í•œë‹¤ (ëŒ€ìš©ëŸ‰ íŒŒì¼ì´ë©´ íš¨ê³¼ê°€ ë” ëšœë ·í•¨).
- ì“°ë ˆë“œê°€ ë‚˜ëˆ ì„œ ì½ê³  `output.dat`ì— ë™ì¼í•œ ìˆœì„œë¡œ ì“°ëŠ” ì˜ˆì œ.

#### ì½”ë“œ

```
#define _GNU_SOURCE
#include <stdio.h>
#include <stdlib.h>
#include <pthread.h>
#include <unistd.h>
#include <fcntl.h>
#include <sys/stat.h>

#define NUM_THREADS 4
#define BLOCK_SIZE  1024 * 1024  // 1MB

typedef struct {
    int thread_id;
    off_t start_offset;
    size_t size;
    const char *input_filename;
    FILE *output_file;
    pthread_mutex_t *output_lock;
} thread_arg_t;

void *download_block(void *arg) {
    thread_arg_t *targ = (thread_arg_t *)arg;
    char *buffer = malloc(targ->size);
    if (!buffer) {
        perror("malloc");
        return NULL;
    }

    FILE *input_file = fopen(targ->input_filename, "rb");
    if (!input_file) {
        perror("fopen input");
        free(buffer);
        return NULL;
    }

    fseeko(input_file, targ->start_offset, SEEK_SET);
    fread(buffer, 1, targ->size, input_file);
    fclose(input_file);

    // ì¶œë ¥ íŒŒì¼ì— ì“°ê¸° (ë®¤í…ìŠ¤ ë³´í˜¸ í•„ìš”)
    pthread_mutex_lock(targ->output_lock);
    fseeko(targ->output_file, targ->start_offset, SEEK_SET);
    fwrite(buffer, 1, targ->size, targ->output_file);
    pthread_mutex_unlock(targ->output_lock);

    printf("Thread %d: copied offset %ld (%zu bytes)\n", targ->thread_id, targ->start_offset, targ->size);

    free(buffer);
    return NULL;
}

int main() {
    pthread_t threads[NUM_THREADS];
    thread_arg_t thread_args[NUM_THREADS];
    pthread_mutex_t output_lock;

    struct stat st;
    if (stat("input.dat", &st) == -1) {
        perror("stat");
        return 1;
    }
    off_t file_size = st.st_size;
    printf("Input file size: %ld bytes\n", file_size);

    FILE *output_file = fopen("output.dat", "wb+");
    if (!output_file) {
        perror("fopen output");
        return 1;
    }

    // output.dat íŒŒì¼ ì‚¬ì´ì¦ˆ ë¯¸ë¦¬ í™•ë³´
    ftruncate(fileno(output_file), file_size);

    pthread_mutex_init(&output_lock, NULL);

    for (int i = 0; i < NUM_THREADS; i++) {
        off_t start = i * (file_size / NUM_THREADS);
        size_t size = (i == NUM_THREADS - 1)
                        ? (file_size - start)
                        : (file_size / NUM_THREADS);

        thread_args[i].thread_id = i;
        thread_args[i].start_offset = start;
        thread_args[i].size = size;
        thread_args[i].input_filename = "input.dat";
        thread_args[i].output_file = output_file;
        thread_args[i].output_lock = &output_lock;

        pthread_create(&threads[i], NULL, download_block, &thread_args[i]);
    }

    for (int i = 0; i < NUM_THREADS; i++) {
        pthread_join(threads[i], NULL);
    }

    pthread_mutex_destroy(&output_lock);
    fclose(output_file);

    printf("Download simulation complete.\n");
    return 0;
}
```

------

### ì‹¤í–‰ íë¦„

1ï¸âƒ£ `input.dat` íŒŒì¼ í¬ê¸° í™•ì¸
 2ï¸âƒ£ NUM_THREADS ê°œìˆ˜ë§Œí¼ ì“°ë ˆë“œ ìƒì„±
 3ï¸âƒ£ ê° ì“°ë ˆë“œëŠ” ì§€ì •ëœ **ì˜¤í”„ì…‹(start_offset)** ë¶€í„° ìì‹ ì˜ ë¸”ë¡ì„ ì½ìŒ
 4ï¸âƒ£ ì½ì€ ë°ì´í„°ë¥¼ **ë®¤í…ìŠ¤ ë³´í˜¸ í•˜ì— output.dat ì— ê¸°ë¡**
 5ï¸âƒ£ ëª¨ë“  ì“°ë ˆë“œ ì™„ë£Œ í›„ í”„ë¡œê·¸ë¨ ì¢…ë£Œ

------

### ì‹¤í–‰ ì˜ˆì‹œ

```
$ ls -lh input.dat
-rw-r--r-- 1 user user 16M input.dat

$ gcc -pthread download_sim.c -o download_sim
$ ./download_sim
Input file size: 16777216 bytes
Thread 0: copied offset 0 (4194304 bytes)
Thread 1: copied offset 4194304 (4194304 bytes)
Thread 2: copied offset 8388608 (4194304 bytes)
Thread 3: copied offset 12582912 (4194304 bytes)
Download simulation complete.
```

â†’ output.datê°€ input.datì™€ **ë™ì¼í•œ ë‚´ìš©ìœ¼ë¡œ ì™„ì„±**ë¨

------

### ê°œì„  ì•„ì´ë””ì–´

- **I/O ìŠ¤ì¼€ì¤„ë§**: ì“°ë ˆë“œê°„ ì‘ì—… ë°°ì¹˜ ìµœì í™”
- **I/O Priority ì¡°ì ˆ** (`ionice` ì‚¬ìš© ê°€ëŠ¥)
- **Buffer í¬ê¸° íŠœë‹**
- **ë™ì  ì‘ì—… í• ë‹¹**: ê° ì“°ë ˆë“œê°€ ìœ íœ´ ìƒíƒœì¼ ë•Œ ë‹¤ìŒ ë¸”ë¡ í• ë‹¹ë°›ê¸° (Work stealing)

------

### ì •ë¦¬

| ê¸°ëŠ¥          | êµ¬í˜„                                   |
| ------------- | -------------------------------------- |
| ë¸”ë¡ ë¶„í•      | ì“°ë ˆë“œë³„ `start_offset`, `size` ê³„ì‚°   |
| ë³‘ë ¬ ë‹¤ìš´ë¡œë“œ | `pthread_create()` ì‚¬ìš©                |
| ì¶œë ¥ ë³´í˜¸     | `pthread_mutex_t` ì‚¬ìš©                 |
| íŒŒì¼ ë³‘í•©     | ëª¨ë“  ë¸”ë¡ì„ output.datì— ìˆœì„œëŒ€ë¡œ ê¸°ë¡ |

------

### ì‹¤ìŠµ ì•„ì´ë””ì–´

- **ì§„ì§œ HTTP Range ìš”ì²­ê³¼ ì—°ê³„**: curl/libcurl + multi-thread + output merge
- **TCP ì„œë²„ì—ì„œ ë¸”ë¡ë³„ ìˆ˜ì‹ ** í›„ ë³‘í•©
- **ë””ìŠ¤í¬ I/O ë²¤ì¹˜ë§ˆí¬ íˆ´ ì œì‘**: IOPS ì¸¡ì •

## ë°ë“œë½ ìƒí™© ìƒì„± ë° í•´ê²°

### 1ï¸âƒ£ ë°ë“œë½(Deadlock)ì´ë€?

**ë°ë“œë½**ì´ë€ **ë‘˜ ì´ìƒì˜ ìŠ¤ë ˆë“œ(ë˜ëŠ” í”„ë¡œì„¸ìŠ¤)ê°€ ì„œë¡œê°€ ë³´ìœ í•œ ìì›ì„ ê¸°ë‹¤ë¦¬ë©´ì„œ ì˜ì›íˆ Block ìƒíƒœ**ê°€ ë˜ëŠ” í˜„ìƒì´ë‹¤.

#### ë°œìƒ ì¡°ê±´ (Coffman ì¡°ê±´ 4ê°€ì§€)

| ì¡°ê±´        | ì„¤ëª…                                     |
| ----------- | ---------------------------------------- |
| ìƒí˜¸ ë°°ì œ   | ìì›ì€ í•œ ë²ˆì— í•˜ë‚˜ì˜ ìŠ¤ë ˆë“œë§Œ ì‚¬ìš© ê°€ëŠ¥ |
| ì ìœ ì™€ ëŒ€ê¸° | ìì›ì„ ì ìœ í•œ ì±„ ë‹¤ë¥¸ ìì›ì„ ìš”ì²­        |
| ë¹„ì„ ì       | ì ìœ í•œ ìì›ì„ ê°•ì œë¡œ ë¹¼ì•—ì„ ìˆ˜ ì—†ìŒ      |
| ìˆœí™˜ ëŒ€ê¸°   | ìŠ¤ë ˆë“œë“¤ì´ ìì›ì„ ìˆœí™˜ êµ¬ì¡°ë¡œ ê¸°ë‹¤ë¦¼     |

â†’ ì´ 4ê°€ì§€ ì¡°ê±´ì´ ëª¨ë‘ ë§Œì¡±ë˜ë©´ ë°ë“œë½ ë°œìƒ ê°€ëŠ¥.

------

### 2ï¸âƒ£ ë°ë“œë½ ìƒí™© ìƒì„± ì˜ˆì œ

#### ì‹œë‚˜ë¦¬ì˜¤

- `Thread 1` â†’ `lock1` íšë“ í›„ `lock2` íšë“ ì‹œë„
- `Thread 2` â†’ `lock2` íšë“ í›„ `lock1` íšë“ ì‹œë„

â†’ **Lock ìˆœì„œ ë°˜ì „**ìœ¼ë¡œ Deadlock ë°œìƒ ê°€ëŠ¥.

#### ì½”ë“œ ì˜ˆì œ

```
#include <stdio.h>
#include <pthread.h>
#include <unistd.h>

pthread_mutex_t lock1;
pthread_mutex_t lock2;

void *thread1_func(void *arg) {
    pthread_mutex_lock(&lock1);
    printf("Thread 1 acquired lock1\n");
    sleep(1);  // ì˜ë„ì  ì§€ì—°

    pthread_mutex_lock(&lock2);
    printf("Thread 1 acquired lock2\n");

    pthread_mutex_unlock(&lock2);
    pthread_mutex_unlock(&lock1);
    return NULL;
}

void *thread2_func(void *arg) {
    pthread_mutex_lock(&lock2);
    printf("Thread 2 acquired lock2\n");
    sleep(1);  // ì˜ë„ì  ì§€ì—°

    pthread_mutex_lock(&lock1);
    printf("Thread 2 acquired lock1\n");

    pthread_mutex_unlock(&lock1);
    pthread_mutex_unlock(&lock2);
    return NULL;
}

int main() {
    pthread_t t1, t2;

    pthread_mutex_init(&lock1, NULL);
    pthread_mutex_init(&lock2, NULL);

    pthread_create(&t1, NULL, thread1_func, NULL);
    pthread_create(&t2, NULL, thread2_func, NULL);

    pthread_join(t1, NULL);
    pthread_join(t2, NULL);

    pthread_mutex_destroy(&lock1);
    pthread_mutex_destroy(&lock2);

    return 0;
}
```

#### ì‹¤í–‰ ê²°ê³¼ ì˜ˆì‹œ

```
Thread 1 acquired lock1
Thread 2 acquired lock2
(ì´í›„ ë©ˆì¶¤ - Deadlock ë°œìƒ)
```

â†’ ê° ìŠ¤ë ˆë“œê°€ ì„œë¡œì˜ Lockì„ ê¸°ë‹¤ë¦¬ë©´ì„œ **ì˜ì›íˆ Block ìƒíƒœ ì§„ì…** â†’ ë°ë“œë½ ë°œìƒ.

------

### 3ï¸âƒ£ ë°ë“œë½ í•´ê²° ë°©ë²•

#### ì›ì¹™: ë°ë“œë½ íšŒí”¼ ë˜ëŠ” ì˜ˆë°©

| ë°©ë²•           | ì„¤ëª…                                                      |
| -------------- | --------------------------------------------------------- |
| Lock ìˆœì„œ ê³ ì • | ëª¨ë“  ìŠ¤ë ˆë“œê°€ ë™ì¼í•œ ìˆœì„œë¡œ Lock íšë“                     |
| Try-Lock ì‚¬ìš©  | `pthread_mutex_trylock()` ì‚¬ìš© â†’ ì‹¤íŒ¨ ì‹œ Backoff or Retry |
| Timeout ë„ì…   | `pthread_mutex_timedlock()` ì‚¬ìš© (POSIX ì˜µì…˜)             |
| Lock ìˆ˜ ì¤„ì´ê¸° | ê°€ëŠ¥í•œ Lock ì˜ì—­ ìµœì†Œí™”                                   |
| ìˆœí™˜ ëŒ€ê¸° ì°¨ë‹¨ | ìì› ìš”ì²­ ì‹œ ì „ì²´ ìˆœì„œ ëª…í™•íˆ ì§€ì •                        |

------

#### í•´ê²° 1: Lock ìˆœì„œ ê³ ì •

**ëª¨ë“  ìŠ¤ë ˆë“œê°€ lock1 â†’ lock2 ìˆœì„œë¡œë§Œ Lock íšë“**

```
void *thread1_func(void *arg) {
    pthread_mutex_lock(&lock1);
    printf("Thread 1 acquired lock1\n");
    sleep(1);

    pthread_mutex_lock(&lock2);
    printf("Thread 1 acquired lock2\n");

    pthread_mutex_unlock(&lock2);
    pthread_mutex_unlock(&lock1);
    return NULL;
}

void *thread2_func(void *arg) {
    pthread_mutex_lock(&lock1);  // ìˆœì„œ ê³ ì •
    printf("Thread 2 acquired lock1\n");
    sleep(1);

    pthread_mutex_lock(&lock2);
    printf("Thread 2 acquired lock2\n");

    pthread_mutex_unlock(&lock2);
    pthread_mutex_unlock(&lock1);
    return NULL;
}
```

â†’ ë°ë“œë½ ë°œìƒí•˜ì§€ ì•ŠìŒ.

------

#### í•´ê²° 2: Try-Lock + Backoff íŒ¨í„´

```
void *thread2_func(void *arg) {
    while (1) {
        pthread_mutex_lock(&lock2);
        printf("Thread 2 acquired lock2\n");

        if (pthread_mutex_trylock(&lock1) == 0) {
            printf("Thread 2 acquired lock1\n");

            pthread_mutex_unlock(&lock1);
            pthread_mutex_unlock(&lock2);
            break;
        } else {
            printf("Thread 2 failed to acquire lock1, releasing lock2 and retrying\n");
            pthread_mutex_unlock(&lock2);
            usleep(100000);  // Backoff (100ms)
        }
    }
    return NULL;
}
```

â†’ **trylock** ì‹¤íŒ¨ ì‹œ lock2 í•´ì œ í›„ ì¬ì‹œë„ â†’ Deadlock íšŒí”¼ ê°€ëŠ¥.

------

#### í•´ê²° 3: Timeout ê¸°ë°˜ Lock

- `pthread_mutex_timedlock()` ì‚¬ìš© â†’ ì¼ì • ì‹œê°„ ë‚´ì— Lock ì‹¤íŒ¨ ì‹œ timeout ë°œìƒ (glibc ì§€ì› í•„ìš”).
- ì‹¤ì‹œê°„ ì‹œìŠ¤í…œì— ìœ ìš©.

```
struct timespec ts;
clock_gettime(CLOCK_REALTIME, &ts);
ts.tv_sec += 1;  // 1ì´ˆ timeout

if (pthread_mutex_timedlock(&lock1, &ts) == ETIMEDOUT) {
    printf("Thread failed to acquire lock1 (timeout)\n");
}
```

------

### 4ï¸âƒ£ ì •ë¦¬

| ë°©ë²•               | ì¥ì           | ë‹¨ì                              |
| ------------------ | ------------- | -------------------------------- |
| Lock ìˆœì„œ ê³ ì •     | ê°„ë‹¨, íš¨ê³¼ì   | ì½”ë“œ ì „ì²´ ì¼ê´€ì„± í•„ìš”            |
| Try-Lock + Backoff | Deadlock íšŒí”¼ | êµ¬í˜„ ë³µì¡ì„± ì¦ê°€, ì„±ëŠ¥ ì €í•˜ ê°€ëŠ¥ |
| Timeout Lock       | ì‹¤ì‹œê°„ì„± í™•ë³´ | í”Œë«í¼/í˜¸í™˜ì„± ë¬¸ì œ, ë³µì¡ì„± ì¦ê°€  |

------

### ì‹¤ìŠµ ì•„ì´ë””ì–´

- **3ê°œ ì´ìƒì˜ Lockìœ¼ë¡œ Deadlock ë°œìƒ í…ŒìŠ¤íŠ¸**
- Try-Lockìœ¼ë¡œ **Adaptive Backoff** êµ¬í˜„ (Backoff ì‹œê°„ ì ì§„ì  ì¦ê°€)
- Thread Poolì—ì„œ Lock ìˆœì„œ ê³ ì • ì„¤ê³„ ì—°ìŠµ

------

### ê²°ë¡ 

- Deadlockì€ **ì„¤ê³„ë‹¨ê³„ì—ì„œ ì˜ˆë°©**í•˜ëŠ” ê²ƒì´ ìµœì„ ì´ë‹¤.
- í•­ìƒ:
  - **Lock ìˆœì„œ ì¼ê´€ì„± ìœ ì§€**
  - **Lock ìµœì†Œí™”**
  - í•„ìš”ì‹œ **Try-Lock/Timeout** ë„ì…
- ì„±ëŠ¥ ìµœì í™”ë³´ë‹¤ **ì•ˆì •ì„± ìš°ì„  ì„¤ê³„**ê°€ ì¤‘ìš”.

## ìƒì‚°ì-ì†Œë¹„ì ë¬¸ì œ Cë¡œ êµ¬í˜„

### ê°œìš”

**ìƒì‚°ì-ì†Œë¹„ì ë¬¸ì œ(Producer-Consumer Problem)** ëŠ” ë©€í‹°ìŠ¤ë ˆë“œ ë™ê¸°í™”ì˜ **ê³ ì „ì  ì˜ˆì œ**ë‹¤.

#### êµ¬ì„±

- **ìƒì‚°ì(Producer)**: ë°ì´í„°ë¥¼ ìƒì„±í•´ì„œ **ë²„í¼ì— ì¶”ê°€**í•¨
- **ì†Œë¹„ì(Consumer)**: ë²„í¼ì—ì„œ ë°ì´í„°ë¥¼ **ì†Œë¹„(ì œê±°)** í•¨
- ë²„í¼ëŠ” **ìœ í•œ í¬ê¸°**ë¥¼ ê°€ì§€ë¯€ë¡œ:
  - ê°€ë“ ì°¼ìœ¼ë©´ ìƒì‚°ìëŠ” **ëŒ€ê¸°**
  - ë¹„ì—ˆìœ¼ë©´ ì†Œë¹„ìëŠ” **ëŒ€ê¸°**

#### ë™ê¸°í™” í•„ìš”ì„±

- **ë®¤í…ìŠ¤(Mutex)**: ë²„í¼ ì ‘ê·¼ ì‹œ ìƒí˜¸ ë°°ì œ ë³´ì¥
- **ì¡°ê±´ ë³€ìˆ˜(Condition Variable)**:
  - ë²„í¼ **ê°€ë“ ì°¸/ë¹„ì–´ ìˆìŒ** ìƒíƒœë¥¼ ìŠ¤ë ˆë“œì—ê²Œ ì•Œë¦¼

------

### 1ï¸âƒ£ êµ¬í˜„ ê°œìš”

#### ë²„í¼ êµ¬ì¡°

```
#define BUFFER_SIZE 10
int buffer[BUFFER_SIZE];
int count = 0;
int in = 0;
int out = 0;
```

- `count` â†’ í˜„ì¬ ë²„í¼ì— ìˆëŠ” ë°ì´í„° ê°œìˆ˜
- `in` â†’ ìƒì‚°ìê°€ ë°ì´í„°ë¥¼ ì¶”ê°€í•  ìœ„ì¹˜
- `out` â†’ ì†Œë¹„ìê°€ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìœ„ì¹˜

#### ë™ê¸°í™” ë„êµ¬

```
pthread_mutex_t mutex;
pthread_cond_t not_full;
pthread_cond_t not_empty;
```

- `mutex` â†’ ì„ê³„ ì˜ì—­ ë³´í˜¸
- `not_full` â†’ ë²„í¼ê°€ ê°€ë“ ì°¨ì§€ ì•Šì•˜ì„ ë•Œ ìƒì‚°ì ëŒ€ê¸° í•´ì œ
- `not_empty` â†’ ë²„í¼ê°€ ë¹„ì–´ ìˆì§€ ì•Šì„ ë•Œ ì†Œë¹„ì ëŒ€ê¸° í•´ì œ

------

### 2ï¸âƒ£ ì „ì²´ ì½”ë“œ ì˜ˆì œ

```
#include <stdio.h>
#include <stdlib.h>
#include <pthread.h>
#include <unistd.h>

#define BUFFER_SIZE 10
#define PRODUCE_ITEMS 20

int buffer[BUFFER_SIZE];
int count = 0;
int in = 0;
int out = 0;

pthread_mutex_t mutex;
pthread_cond_t not_full;
pthread_cond_t not_empty;

void *producer(void *arg) {
    for (int i = 1; i <= PRODUCE_ITEMS; i++) {
        pthread_mutex_lock(&mutex);

        // ë²„í¼ê°€ ê°€ë“ ì°¨ ìˆìœ¼ë©´ ëŒ€ê¸°
        while (count == BUFFER_SIZE) {
            pthread_cond_wait(&not_full, &mutex);
        }

        // ë²„í¼ì— ë°ì´í„° ì¶”ê°€
        buffer[in] = i;
        in = (in + 1) % BUFFER_SIZE;
        count++;

        printf("Producer: produced item %d (count = %d)\n", i, count);

        // ì†Œë¹„ìì—ê²Œ ì•Œë¦¼
        pthread_cond_signal(&not_empty);

        pthread_mutex_unlock(&mutex);

        usleep(100000);  // 0.1ì´ˆ sleep â†’ ìƒì‚° ì†ë„ ì¡°ì ˆ
    }
    return NULL;
}

void *consumer(void *arg) {
    for (int i = 1; i <= PRODUCE_ITEMS; i++) {
        pthread_mutex_lock(&mutex);

        // ë²„í¼ê°€ ë¹„ì–´ ìˆìœ¼ë©´ ëŒ€ê¸°
        while (count == 0) {
            pthread_cond_wait(&not_empty, &mutex);
        }

        // ë²„í¼ì—ì„œ ë°ì´í„° ì†Œë¹„
        int item = buffer[out];
        out = (out + 1) % BUFFER_SIZE;
        count--;

        printf("Consumer: consumed item %d (count = %d)\n", item, count);

        // ìƒì‚°ìì—ê²Œ ì•Œë¦¼
        pthread_cond_signal(&not_full);

        pthread_mutex_unlock(&mutex);

        usleep(150000);  // 0.15ì´ˆ sleep â†’ ì†Œë¹„ ì†ë„ ì¡°ì ˆ
    }
    return NULL;
}

int main() {
    pthread_t prod_thread, cons_thread;

    pthread_mutex_init(&mutex, NULL);
    pthread_cond_init(&not_full, NULL);
    pthread_cond_init(&not_empty, NULL);

    pthread_create(&prod_thread, NULL, producer, NULL);
    pthread_create(&cons_thread, NULL, consumer, NULL);

    pthread_join(prod_thread, NULL);
    pthread_join(cons_thread, NULL);

    pthread_mutex_destroy(&mutex);
    pthread_cond_destroy(&not_full);
    pthread_cond_destroy(&not_empty);

    return 0;
}
```

------

### 3ï¸âƒ£ ì‹¤í–‰ ê²°ê³¼ ì˜ˆì‹œ

```
Producer: produced item 1 (count = 1)
Consumer: consumed item 1 (count = 0)
Producer: produced item 2 (count = 1)
Producer: produced item 3 (count = 2)
Consumer: consumed item 2 (count = 1)
...
Producer: produced item 20 (count = 2)
Consumer: consumed item 20 (count = 1)
```

â†’ ìƒì‚°ìì™€ ì†Œë¹„ìê°€ **ìƒí˜¸ í˜‘ë ¥**í•˜ì—¬ ë²„í¼ë¥¼ ì ì ˆíˆ ì±„ìš°ê³  ë¹„ì›€.

------

### 4ï¸âƒ£ ë™ì‘ íë¦„

 1ï¸âƒ£ ìƒì‚°ìëŠ” ë²„í¼ê°€ ê°€ë“ ì°¨ë©´ `not_full` ì¡°ê±´ ë³€ìˆ˜ì—ì„œ ëŒ€ê¸°
 2ï¸âƒ£ ì†Œë¹„ìê°€ ì•„ì´í…œì„ ì†Œë¹„ â†’ `pthread_cond_signal(&not_full)` ë¡œ ìƒì‚°ì ê¹¨ì›€
 3ï¸âƒ£ ì†Œë¹„ìëŠ” ë²„í¼ê°€ ë¹„ë©´ `not_empty` ì¡°ê±´ ë³€ìˆ˜ì—ì„œ ëŒ€ê¸°
 4ï¸âƒ£ ìƒì‚°ìê°€ ì•„ì´í…œì„ ì¶”ê°€ â†’ `pthread_cond_signal(&not_empty)` ë¡œ ì†Œë¹„ì ê¹¨ì›€
 5ï¸âƒ£ ë°˜ë³µ

------

### 5ï¸âƒ£ í•µì‹¬ í¬ì¸íŠ¸

| ìš”ì†Œ                       | ì‚¬ìš© ì´ìœ                                         |
| -------------------------- | ------------------------------------------------ |
| `pthread_mutex_t mutex`    | ë²„í¼ ì ‘ê·¼ ì‹œ ìƒí˜¸ ë°°ì œ                           |
| `pthread_cond_t not_full`  | ë²„í¼ê°€ ê°€ë“ ì°¼ì„ ë•Œ ìƒì‚°ì ëŒ€ê¸°                  |
| `pthread_cond_t not_empty` | ë²„í¼ê°€ ë¹„ì—ˆì„ ë•Œ ì†Œë¹„ì ëŒ€ê¸°                     |
| `while` ë£¨í”„ ì‚¬ìš©          | **Spurious wakeup** ëŒ€ì‘ â†’ í•­ìƒ ì¡°ê±´ ì¬í™•ì¸ í•„ìš” |

------

### 6ï¸âƒ£ ì‹¤ìŠµ ì•„ì´ë””ì–´

- **ë‹¤ìˆ˜ ìƒì‚°ì/ë‹¤ìˆ˜ ì†Œë¹„ì** êµ¬í˜„í•´ë³´ê¸°
- ìƒì‚°/ì†Œë¹„ ì†ë„ë¥¼ ë‹¤ë¥´ê²Œ ì¡°ì •í•´ race condition ì‹¤í—˜í•˜ê¸°
- `pthread_cond_broadcast()` ì‚¬ìš© ì‹¤í—˜
- `pthread_cond_timedwait()` ì‚¬ìš©í•´ timeout ì²˜ë¦¬í•´ë³´ê¸°

------

### 7ï¸âƒ£ ê²°ë¡ 

- **ìƒì‚°ì-ì†Œë¹„ì ë¬¸ì œ**ëŠ” ë©€í‹°ìŠ¤ë ˆë“œ ë™ê¸°í™” ì„¤ê³„ì˜ ëŒ€í‘œì  ì˜ˆì œ.
- ë°˜ë“œì‹œ:
  - **ë®¤í…ìŠ¤ + ì¡°ê±´ ë³€ìˆ˜** ì¡°í•© ì‚¬ìš©
  - while ì¡°ê±´ í™•ì¸ íŒ¨í„´ ì ìš© â†’ **ê¹¨ìš´ë‹¤ê³  ë°”ë¡œ ì¡°ê±´ì´ ë§Œì¡±ë˜ëŠ” ê²ƒ ì•„ë‹˜!**
- ì‹¤ì œ ì‘ìš©: **Thread Pool**, **I/O Buffering**, **Pipeline Architecture** ë“±ì— í•µì‹¬ì ìœ¼ë¡œ ì‚¬ìš©ëœë‹¤.