# 10. ë¦¬ëˆ…ìŠ¤ ì»¤ë„ ëª¨ë“ˆ ì…ë¬¸ (ê³ ê¸‰)

## 10.1 ì»¤ë„ ë¹Œë“œ ê°œë… ë° `Makefile` ì‘ì„±

### ğŸ§  1. ì»¤ë„ ëª¨ë“ˆ ë¹Œë“œì™€ ì¼ë°˜ C í”„ë¡œê·¸ë¨ì˜ ì°¨ì´

| êµ¬ë¶„               | ì¼ë°˜ C í”„ë¡œê·¸ë¨                      | ì»¤ë„ ëª¨ë“ˆ                        |
| ------------------ | ------------------------------------ | -------------------------------- |
| ì‹¤í–‰ í™˜ê²½          | ì‚¬ìš©ì ê³µê°„ (User Space)             | ì»¤ë„ ê³µê°„ (Kernel Space)         |
| ì‹¤í–‰ íŒŒì¼          | ELF ì‹¤í–‰íŒŒì¼ (`a.out`, `*.elf`)      | ì»¤ë„ ì˜¤ë¸Œì íŠ¸ íŒŒì¼ (`.ko`)       |
| ë§ì»¤ ë° ë¼ì´ë¸ŒëŸ¬ë¦¬ | `glibc`, `libc.so`, `ld-linux.so` ë“± | ì‚¬ìš©ì ê³µê°„ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš© ê¸ˆì§€ |
| ë¹Œë“œ ëª…ë ¹          | `gcc main.c -o app`                  | `make` + ì»¤ë„ Makefile ì‚¬ìš©      |

#### âœ… ì»¤ë„ ëª¨ë“ˆì€ ì»¤ë„ ë‚´ë¶€ í•¨ìˆ˜ì™€ êµ¬ì¡°ì²´ë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ

> ë°˜ë“œì‹œ **ì»¤ë„ ë¹Œë“œ í™˜ê²½** ë˜ëŠ” **ì»¤ë„ í—¤ë” ë””ë ‰í† ë¦¬**ê°€ í•„ìš”í•´.
>  ë³´í†µ `/lib/modules/$(uname -r)/build` ê²½ë¡œë¡œ ì œê³µë¨.

------

### ğŸ§± 2. ì»¤ë„ ëª¨ë“ˆ ë””ë ‰í† ë¦¬ êµ¬ì¡° ì˜ˆì‹œ

```
my_module/
â”œâ”€â”€ Makefile
â””â”€â”€ hello.c
```

#### `hello.c` (ì˜ˆì œ ì»¤ë„ ëª¨ë“ˆ)

```
#include <linux/module.h>
#include <linux/kernel.h>

int init_module(void) {
    printk(KERN_INFO "Hello, kernel world!\n");
    return 0;
}

void cleanup_module(void) {
    printk(KERN_INFO "Goodbye, kernel world!\n");
}
```

------

### ğŸ§¾ 3. Makefile êµ¬ì¡° (ì»¤ë„ ëª¨ë“ˆìš©)

```
# Makefile
obj-m := hello.o

KDIR := /lib/modules/$(shell uname -r)/build
PWD := $(shell pwd)

all:
	make -C $(KDIR) M=$(PWD) modules

clean:
	make -C $(KDIR) M=$(PWD) clean
```

#### ê° ì¤„ì˜ ì˜ë¯¸

| ëª…ë ¹ì–´                     | ì„¤ëª…                                  |
| -------------------------- | ------------------------------------- |
| `obj-m := hello.o`         | ì»¤ë„ ëª¨ë“ˆë¡œ ë¹Œë“œí•  ëŒ€ìƒ (í™•ì¥ì `.o`) |
| `KDIR := .../build`        | í˜„ì¬ ì‹œìŠ¤í…œì˜ ì»¤ë„ ì†ŒìŠ¤/í—¤ë” ë””ë ‰í† ë¦¬ |
| `PWD := $(shell pwd)`      | í˜„ì¬ ëª¨ë“ˆì´ ìˆëŠ” ë””ë ‰í† ë¦¬             |
| `make -C $(KDIR) M=$(PWD)` | ì»¤ë„ ë¹Œë“œ ì‹œìŠ¤í…œì— ëª¨ë“ˆ ë””ë ‰í† ë¦¬ ìœ„ì„ |
| `modules`                  | ì‹¤ì œ `.ko` ëª¨ë“ˆ ë¹Œë“œ íƒ€ê²Ÿ             |
| `clean`                    | ì¤‘ê°„ ì‚°ì¶œë¬¼ ì •ë¦¬ (ëª¨ë“ˆ ì‚­ì œ)          |

------

### âš™ï¸ 4. ë¹Œë“œ ë° ë¡œë”© ì ˆì°¨

```
$ make        # hello.ko ìƒì„±ë¨
$ sudo insmod hello.ko
$ dmesg       # "Hello, kernel world!" ì¶œë ¥ í™•ì¸
$ sudo rmmod hello
$ dmesg       # "Goodbye, kernel world!" ì¶œë ¥ í™•ì¸
```

------

### ğŸ› ï¸ 5. ì»¤ë„ í—¤ë” ì„¤ì¹˜ í™•ì¸ ë° í™˜ê²½ ì„¤ì •

```
# ì»¤ë„ í—¤ë” ì„¤ì¹˜ ì—¬ë¶€ í™•ì¸
$ ls /lib/modules/$(uname -r)/build

# ì„¤ì¹˜ê°€ ì•ˆ ë˜ì–´ ìˆë‹¤ë©´
$ sudo apt install linux-headers-$(uname -r)
```

------

### ğŸ” 6. í™•ì¥ í¬ì¸íŠ¸ (ì‹¬í™” í•™ìŠµ ë°©í–¥)

| ì£¼ì œ                              | ì„¤ëª…                                              |
| --------------------------------- | ------------------------------------------------- |
| `MODULE_LICENSE()`                | GPL ëª…ì‹œ ì—¬ë¶€ì— ë”°ë¼ ì‹¬ë³¼ ì œí•œ ì¡´ì¬               |
| `module_init()` / `module_exit()` | í˜„ëŒ€ ì»¤ë„ì—ì„œ ê¶Œì¥ë˜ëŠ” ì´ˆê¸°í™”/ì¢…ë£Œ í•¨ìˆ˜ ë“±ë¡ ë°©ì‹ |
| ì»¤ë„ ì‹¬ë³¼ í™•ì¸                    | `/proc/kallsyms`ì—ì„œ ëª¨ë“ˆ í•¨ìˆ˜ ìœ„ì¹˜ í™•ì¸ ê°€ëŠ¥     |
| ì˜ì¡´ì„± ì„¤ì •                       | `obj-m += a.o b.o`ë¡œ ë‹¤ì¤‘ ëª¨ë“ˆ ì„¤ì • ê°€ëŠ¥          |

------

### âœ… ì‹¤ìŠµ ì²´í¬ë¦¬ìŠ¤íŠ¸

-  ì»¤ë„ í—¤ë” ì„¤ì¹˜
-  `hello.c` ì‘ì„±
-  Makefile ì‘ì„±
-  `make` â†’ `.ko` ìƒì„±
-  `insmod`, `rmmod` í…ŒìŠ¤íŠ¸
-  `dmesg` ë¡œê·¸ í™•ì¸

## 10.2 ê°„ë‹¨í•œ ì»¤ë„ ëª¨ë“ˆ (`printk`)

### 1ï¸âƒ£ `printk()`ë€?

- ìš´ì˜ì²´ì œ ì»¤ë„ ê³µê°„ì—ì„œ ì‚¬ìš©í•˜ëŠ” **ë¡œê·¸ ì¶œë ¥ í•¨ìˆ˜**
- `printf()` ì™€ ë¹„ìŠ·í•˜ì§€ë§Œ **ì»¤ë„ ê³µê°„ ì „ìš©**
- ì¶œë ¥ëœ ë©”ì‹œì§€ëŠ” **ì»¤ë„ ë¡œê·¸ ë²„í¼**ì— ì €ì¥ë¨ â†’ `dmesg` ëª…ë ¹ìœ¼ë¡œ í™•ì¸

#### ê¸°ë³¸ ì‚¬ìš©ë²•

```
printk(KERN_INFO "Hello from kernel!\n");
```

#### ë¡œê·¸ ë ˆë²¨ (ìš°ì„ ìˆœìœ„)

| ë ˆë²¨ ë§¤í¬ë¡œ    | ì˜ë¯¸                 | ë¡œê·¸ ì‹¬ê°ë„ |
| -------------- | -------------------- | ----------- |
| `KERN_EMERG`   | ì‹œìŠ¤í…œ ê¸´ê¸‰ ìƒí™©     | 0           |
| `KERN_ALERT`   | ì¦‰ê° ì¡°ì¹˜ í•„ìš”       | 1           |
| `KERN_CRIT`    | ì¹˜ëª…ì  ì˜¤ë¥˜          | 2           |
| `KERN_ERR`     | ì˜¤ë¥˜ ë°œìƒ            | 3           |
| `KERN_WARNING` | ê²½ê³                  | 4           |
| `KERN_NOTICE`  | ì¼ë°˜ì ì¸ ì¤‘ìš” ì •ë³´   | 5           |
| `KERN_INFO`    | ì¼ë°˜ ì •ë³´ ë©”ì‹œì§€     | 6           |
| `KERN_DEBUG`   | ë””ë²„ê·¸ìš© ìƒì„¸ ë©”ì‹œì§€ | 7           |

- ë¡œê·¸ ë ˆë²¨ì„ ìƒëµí•˜ë©´ ê¸°ë³¸ `DEFAULT_MESSAGE_LOGLEVEL` ì‚¬ìš©ë¨

------

### 2ï¸âƒ£ ê°„ë‹¨í•œ ì»¤ë„ ëª¨ë“ˆ ì˜ˆì œ (Hello World ëª¨ë“ˆ)

#### ğŸ“„ hello.c

```
#include <linux/module.h>    // í•„ìˆ˜: module_init, module_exit, MODULE_LICENSE
#include <linux/kernel.h>    // í•„ìˆ˜: printk

static int __init hello_init(void) {
    printk(KERN_INFO "Hello, Kernel World! Module loaded.\n");
    return 0;
}

static void __exit hello_exit(void) {
    printk(KERN_INFO "Goodbye, Kernel World! Module removed.\n");
}

module_init(hello_init);
module_exit(hello_exit);

MODULE_LICENSE("GPL");
MODULE_AUTHOR("Your Name");
MODULE_DESCRIPTION("A simple Hello World Kernel Module");
```

#### í•µì‹¬ í¬ì¸íŠ¸ ì„¤ëª…

| ì½”ë“œ ìš”ì†Œ                   | ì„¤ëª…                                             |
| --------------------------- | ------------------------------------------------ |
| `#include <linux/module.h>` | ì»¤ë„ ëª¨ë“ˆ ê´€ë ¨ API í—¤ë”                          |
| `#include <linux/kernel.h>` | `printk` ë° ì»¤ë„ ê´€ë ¨ ì •ì˜ í¬í•¨                  |
| `__init`, `__exit`          | í•¨ìˆ˜ ìµœì í™” ë§¤í¬ë¡œ (ì´ˆê¸°í™”, ì¢…ë£Œìš©)              |
| `module_init()`             | ëª¨ë“ˆ ë¡œë“œì‹œ ì‹¤í–‰ í•¨ìˆ˜ ë“±ë¡                       |
| `module_exit()`             | ëª¨ë“ˆ ì œê±°ì‹œ ì‹¤í–‰ í•¨ìˆ˜ ë“±ë¡                       |
| `MODULE_LICENSE()`          | ëª¨ë“ˆì˜ ë¼ì´ì„¼ìŠ¤ ëª…ì‹œ â†’ GPL í•„ìˆ˜ (ë¯¸ì§€ì • ì‹œ ê²½ê³ ) |
| `printk()`                  | ì»¤ë„ ë¡œê·¸ ì¶œë ¥                                   |

------

### 3ï¸âƒ£ Makefile (ë³µìŠµ ì°¨ì›ì—ì„œ ì¬í™•ì¸)

```
obj-m := hello.o

KDIR := /lib/modules/$(shell uname -r)/build
PWD := $(shell pwd)

all:
	make -C $(KDIR) M=$(PWD) modules

clean:
	make -C $(KDIR) M=$(PWD) clean
```

------

### 4ï¸âƒ£ ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ë°©ë²•

#### ë¹Œë“œ

```
$ make
```

#### ëª¨ë“ˆ ì‚½ì…

```
$ sudo insmod hello.ko
```

#### ì»¤ë„ ë¡œê·¸ í™•ì¸

```
$ dmesg | tail -n 20
```

#### ëª¨ë“ˆ ì œê±°

```
$ sudo rmmod hello
```

#### ë‹¤ì‹œ ì»¤ë„ ë¡œê·¸ í™•ì¸

```
$ dmesg | tail -n 20
```

------

### 5ï¸âƒ£ ê²°ê³¼ ì˜ˆì‹œ

```
[12345.678901] Hello, Kernel World! Module loaded.
[12347.890123] Goodbye, Kernel World! Module removed.
```

------

### 6ï¸âƒ£ ì‹¬í™” í¬ì¸íŠ¸

- `KERN_INFO`, `KERN_WARNING` ë“± ë‹¤ë¥¸ ë ˆë²¨ë¡œë„ ì¶œë ¥í•´ë³´ê¸°
- ì—¬ëŸ¬ ì¤„ ë©”ì‹œì§€ ì¶œë ¥ (ë©€í‹°ë¼ì¸ `printk`)
- ë³€ìˆ˜ ê°’ ì¶œë ¥ ì‹¤ìŠµ â†’ `printk(KERN_INFO "Value: %d\n", my_value);`
- íƒ€ì´ë°ì— ë”°ë¥¸ ì¶œë ¥ ìˆœì„œ ê´€ì°° â†’ ì‹œê°„ ì¸¡ì • / ë£¨í”„ ì¶”ê°€

------

### âœ… ì‹¤ìŠµ ì²´í¬ë¦¬ìŠ¤íŠ¸

-  `hello.c` ì‘ì„±
-  `Makefile` ì‘ì„±
-  `make` â†’ `hello.ko` ìƒì„±
-  `insmod` â†’ `dmesg` í™•ì¸
-  `rmmod` â†’ `dmesg` í™•ì¸
-  ë‹¤ë¥¸ ë¡œê·¸ ë ˆë²¨ í…ŒìŠ¤íŠ¸

## 10.3 ëª¨ë“ˆ ì‚½ì…/ì‚­ì œ (`insmod`, `rmmod`)

### 1ï¸âƒ£ ì»¤ë„ ëª¨ë“ˆì˜ ì—­í• 

- **ì»¤ë„ ê¸°ëŠ¥ì„ ë™ì ìœ¼ë¡œ í™•ì¥**í•˜ëŠ” ì½”ë“œ ì¡°ê°
- ì „í†µì  ì»¤ë„ ë¹Œë“œ í›„ ì •ì  í¬í•¨ ëŒ€ì‹  â†’ í•„ìš”í•  ë•Œë§Œ **ì‚½ì… / ì œê±°** ê°€ëŠ¥

#### ì£¼ìš” ì‚¬ìš© ì˜ˆ

| ìƒí™©                   | ëª¨ë“ˆ ì˜ˆì‹œ           |
| ---------------------- | ------------------- |
| ë„¤íŠ¸ì›Œí¬ ë“œë¼ì´ë²„ ë¡œë“œ | `e1000e.ko`         |
| íŒŒì¼ ì‹œìŠ¤í…œ ì§€ì› ì¶”ê°€  | `nfs.ko`, `cifs.ko` |
| ì»¤ë„ ë””ë²„ê·¸ìš© ëª¨ë“ˆ     | `hello.ko` (í•™ìŠµìš©) |

------

### 2ï¸âƒ£ ëª¨ë“ˆ ê´€ë¦¬ ëª…ë ¹ì–´

#### 1. `insmod`

- ëª¨ë“ˆ íŒŒì¼ (`.ko`)ì„ ì»¤ë„ì— **ì‚½ì…**í•˜ëŠ” ëª…ë ¹
- ê¸°ë³¸ ë¬¸ë²•

```
sudo insmod hello.ko
```

- íŠ¹ì§•
  - **ì˜ì¡´ì„± ìë™ ì²˜ë¦¬ ë¶ˆê°€**
  - ì‹¬ë³¼ ì¶©ëŒ ë°œìƒ ì‹œ ì˜¤ë¥˜ ë°œìƒ ê°€ëŠ¥
  - ë‹¨ìˆœ **ë¡œìš° ë ˆë²¨ ë¡œë“œ**

#### 2. `rmmod`

- í˜„ì¬ ì»¤ë„ì— **ë¡œë“œëœ ëª¨ë“ˆ ì œê±°** ëª…ë ¹
- ê¸°ë³¸ ë¬¸ë²•

```
sudo rmmod hello
```

- íŠ¹ì§•
  - `.ko` í™•ì¥ì ì‚¬ìš© ì•ˆ í•¨ â†’ ëª¨ë“ˆ ì´ë¦„ë§Œ ì§€ì •
  - ëª¨ë“ˆì´ **busy** ìƒíƒœë©´ ì œê±° ì‹¤íŒ¨

------

### 3ï¸âƒ£ ë¡œë“œ/ì–¸ë¡œë“œ ì‹œ ë‚´ë¶€ íë¦„

#### ëª¨ë“ˆ ë¡œë“œ

```
insmod â†’ module_init() í˜¸ì¶œ â†’ init_module() or ì‚¬ìš©ì ì •ì˜ ì´ˆê¸°í™” í•¨ìˆ˜ ì‹¤í–‰
```

#### ëª¨ë“ˆ ì œê±°

```
rmmod â†’ module_exit() í˜¸ì¶œ â†’ cleanup_module() or ì‚¬ìš©ì ì •ì˜ ì¢…ë£Œ í•¨ìˆ˜ ì‹¤í–‰
```

â†’ ìš°ë¦¬ëŠ” ì•ì„œ `hello.c`ì—ì„œ `hello_init()`ê³¼ `hello_exit()`ìœ¼ë¡œ ì´ íë¦„ì„ êµ¬ì„±í–ˆì§€.

------

### 4ï¸âƒ£ ì»¤ë„ ëª¨ë“ˆ ìƒíƒœ í™•ì¸

#### `lsmod`

- í˜„ì¬ ì»¤ë„ì— **ë¡œë“œëœ ëª¨ë“ˆ ëª©ë¡** í™•ì¸

```
lsmod
```

ì¶œë ¥ ì˜ˆì‹œ:

```
Module                  Size  Used by
hello                   16384  0
...
```

#### `modinfo`

- íŠ¹ì • ëª¨ë“ˆì˜ **ì •ë³´ í™•ì¸**

```
modinfo hello.ko
```

ì¶œë ¥ ì˜ˆì‹œ:

```
filename:       /path/to/hello.ko
license:        GPL
author:         Your Name
description:    A simple Hello World Kernel Module
vermagic:       5.15.0-56-generic SMP mod_unload
```

------

### 5ï¸âƒ£ ì˜ì¡´ì„± ê´€ë¦¬ - `modprobe` (ë¯¸ë¦¬ ì†Œê°œ)

> `modprobe`ëŠ” `insmod`ë³´ë‹¤ **ê³ ê¸‰ ê¸°ëŠ¥** ì œê³µ:

- ëª¨ë“ˆ ê°„ ì˜ì¡´ì„± (`depmod` ì •ë³´) ìë™ ì²˜ë¦¬
- ëª¨ë“ˆ íŒŒë¼ë¯¸í„° ì „ë‹¬ ê°€ëŠ¥

```
sudo modprobe hello
sudo modprobe -r hello
```

â€» `modprobe`ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ `/lib/modules/$(uname -r)/modules.dep` êµ¬ì¶• í•„ìš”
 â†’ `depmod` ëª…ë ¹ì–´ë¡œ ì¬ìƒì„± ê°€ëŠ¥

------

### 6ï¸âƒ£ ëª¨ë“ˆ ì œê±° ì‹¤íŒ¨ ìƒí™© (ì¤‘ìš” â­)

#### `rmmod` ì˜¤ë¥˜ ì˜ˆì‹œ

```
rmmod: ERROR: Module hello is in use
```

- ë³´í†µ `Used by` í•„ë“œê°€ 0ì´ ì•„ë‹Œ ê²½ìš° ë°œìƒ
- í•´ê²° ë°©ë²•:
  - ì‚¬ìš© ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
  - ê´€ë ¨ ì°¸ì¡° í•´ì œ
  - `rmmod -f hello` ê°•ì œ ì œê±° (ê¶Œì¥ X â†’ ì‹¤ìŠµìš©ë§Œ)

```
sudo rmmod -f hello
```

â€» ê°•ì œ ì œê±°ëŠ” ì»¤ë„ íŒ¨ë‹‰ ìœ„í—˜ ìˆìœ¼ë‹ˆ ì£¼ì˜!

------

### 7ï¸âƒ£ ì‹¤ìŠµ ì ˆì°¨

#### 1ï¸âƒ£ ëª¨ë“ˆ ë¹Œë“œ

```
make
```

#### 2ï¸âƒ£ ëª¨ë“ˆ ì‚½ì…

```
sudo insmod hello.ko
dmesg | tail -n 20
```

#### 3ï¸âƒ£ ëª¨ë“ˆ ìƒíƒœ í™•ì¸

```
lsmod | grep hello
modinfo hello.ko
```

#### 4ï¸âƒ£ ëª¨ë“ˆ ì œê±°

```
sudo rmmod hello
dmesg | tail -n 20
```

------

### âœ… ì‹¤ìŠµ ì²´í¬ë¦¬ìŠ¤íŠ¸

-  `insmod` ë¡œë“œ í›„ `dmesg` í™•ì¸
-  `lsmod`ë¡œ ëª¨ë“ˆ í™•ì¸
-  `modinfo`ë¡œ ì •ë³´ ì¶œë ¥ í™•ì¸
-  `rmmod`ë¡œ ì œê±° í›„ `dmesg` í™•ì¸
-  ì œê±° ì˜¤ë¥˜ ìƒí™© ì²´í—˜ (`rmmod -f`ëŠ” ì‹¤ìŠµìš©ë§Œ!)

## 10.4 ì»¤ë„ ë¡œê·¸ í™•ì¸ (`dmesg`)

### ğŸ§  1. ì»¤ë„ ë©”ì‹œì§€ ë²„í¼ë€?

ë¦¬ëˆ…ìŠ¤ ì»¤ë„ì€ ìì²´ ë¡œê·¸ ë©”ì‹œì§€ë¥¼ **ë©”ëª¨ë¦¬ ë‚´ë¶€ì˜ ë§ ë²„í¼(Ring Buffer)** ì— ì €ì¥í•´.
 ì´ ë²„í¼ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ì •ë³´ë¥¼ ë‹´ê³  ìˆìŒ:

- `printk()`ìœ¼ë¡œ ì¶œë ¥ëœ ë©”ì‹œì§€
- ì»¤ë„ ë¶€íŒ… ê³¼ì • ë©”ì‹œì§€
- ë“œë¼ì´ë²„ ë¡œë”©/ì–¸ë¡œë”© ë©”ì‹œì§€
- ì‹œìŠ¤í…œ ì½œ ì‹¤íŒ¨ë‚˜ ê²½ê³  ë“±

#### íŠ¹ì„±

| í•­ëª©                 | ì„¤ëª…                          |
| -------------------- | ----------------------------- |
| ë§ ë²„í¼ êµ¬ì¡°         | ì˜¤ë˜ëœ ë¡œê·¸ëŠ” ìë™ìœ¼ë¡œ ì‚­ì œë¨ |
| ì‚¬ìš©ì ê³µê°„ ì ‘ê·¼     | `dmesg`, `journalctl -k` ì‚¬ìš© |
| ì»¤ë„ ë‚´ë¶€ ì¸í„°í˜ì´ìŠ¤ | `/dev/kmsg`, `/proc/kmsg` ë“±  |

------

### ğŸ§° 2. `dmesg` ëª…ë ¹ì–´ì˜ ì—­í• 

- ì»¤ë„ ë§ ë²„í¼ì˜ ë‚´ìš©ì„ **ì‚¬ìš©ì ê³µê°„ì—ì„œ ì¶œë ¥**
- ì£¼ë¡œ ë””ë²„ê¹…, ëª¨ë“ˆ ë¡œë”© í™•ì¸, í•˜ë“œì›¨ì–´ ìƒíƒœ í™•ì¸ ë“±ì— ì‚¬ìš©ë¨

#### ê¸°ë³¸ ì‚¬ìš©ë²•

```
$ dmesg
```

ì¶œë ¥ ì˜ˆì‹œ:

```
[  123.456789] Hello, Kernel World! Module loaded.
[  125.123456] Goodbye, Kernel World! Module removed.
```

> ì‹œê°„ì€ ë¶€íŒ… í›„ ê²½ê³¼ ì‹œê°„ (ì´ˆ) ê¸°ì¤€

------

### ğŸ” 3. ìì£¼ ì‚¬ìš©í•˜ëŠ” ì˜µì…˜

| ëª…ë ¹ì–´             | ì„¤ëª…                                    |
| ------------------ | --------------------------------------- |
| `dmesg             | tail`                                   |
| `dmesg -T`         | **ì‚¬ëŒì´ ì½ê¸° ì‰¬ìš´ ì‹œê°„** í‘œì‹œ          |
| `dmesg -k`         | ì»¤ë„ ë©”ì‹œì§€ë§Œ ì¶œë ¥ (Syslog ë©”ì‹œì§€ ì œì™¸) |
| `dmesg -n <level>` | ì¶œë ¥í•  ìµœëŒ€ ë¡œê·¸ ë ˆë²¨ ì§€ì •              |
| `dmesg -w`         | **ì‹¤ì‹œê°„ ë¡œê·¸ ê°ì‹œ (watch)**            |

#### ì˜ˆì œ

```
$ dmesg -T | tail -n 10
$ dmesg -w   # ì‹¤ì‹œê°„ ë¡œê·¸ í™•ì¸
```

------

### ğŸ§µ 4. ë¡œê·¸ ë ˆë²¨ í•„í„°ë§ (`printk` ë¡œê·¸ ìš°ì„ ìˆœìœ„)

```
printk(KERN_INFO "This is info log\n");
printk(KERN_WARNING "Warning!\n");
printk(KERN_ERR "Critical Error!\n");
```

#### `dmesg -n LEVEL` ì˜ë¯¸

```
$ dmesg -n 3
```

â†’ `KERN_ERR` ì´í•˜ (ì¦‰, 0~3 ìˆ˜ì¤€ì˜ ë¡œê·¸ë§Œ ì¶œë ¥)

| ìˆ«ì | ìš°ì„ ìˆœìœ„  | ë§¤í¬ë¡œ         |
| ---- | --------- | -------------- |
| 0    | ê¸´ê¸‰      | `KERN_EMERG`   |
| 1    | ê²½ê³       | `KERN_ALERT`   |
| 2    | ì¤‘ìš” ì˜¤ë¥˜ | `KERN_CRIT`    |
| 3    | ì¼ë°˜ ì˜¤ë¥˜ | `KERN_ERR`     |
| 4    | ê²½ê³       | `KERN_WARNING` |
| 5    | ê³µì§€ì‚¬í•­  | `KERN_NOTICE`  |
| 6    | ì •ë³´      | `KERN_INFO`    |
| 7    | ë””ë²„ê¹…    | `KERN_DEBUG`   |

------

### ğŸ“ 5. ë‚´ë¶€ ê²½ë¡œ: `/proc/kmsg`, `/dev/kmsg`

| íŒŒì¼ ê²½ë¡œ    | ì„¤ëª…                                      |
| ------------ | ----------------------------------------- |
| `/proc/kmsg` | ì»¤ë„ ë©”ì‹œì§€ ìŠ¤íŠ¸ë¦¼ (ì½ìœ¼ë©´ ë¹„ì›Œì§)        |
| `/dev/kmsg`  | ì»¤ë„ ë¡œê·¸ ì¥ì¹˜ íŒŒì¼ (`dmesg`ë„ ì—¬ê¸¸ ì½ìŒ) |

```
sudo cat /proc/kmsg      # ì»¤ë„ ë¡œê·¸ ì§ì ‘ ì½ê¸°
sudo cat /dev/kmsg       # ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¼ í˜•íƒœë¡œ ì¶œë ¥ë¨
```

â€» ë³´ì•ˆ ìƒ ì¼ë°˜ ì‚¬ìš©ìì—ê² ì ‘ê·¼ ì œí•œë¨

------

### ğŸ§ª 6. ì‹¤ìŠµ ì˜ˆì‹œ

1. ëª¨ë“ˆ ì‚½ì… â†’ ë¡œê·¸ í™•ì¸

```
$ sudo insmod hello.ko
$ dmesg | tail -n 5
```

1. ë¡œê·¸ì— ì‹œê°„ í‘œì‹œ ì¶”ê°€

```
$ dmesg -T | tail -n 5
```

1. ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§

```
$ dmesg -w
```

â†’ `rmmod` ëª…ë ¹ì„ ì‹¤í–‰í•´ë³´ë©´ ì‹¤ì‹œê°„ìœ¼ë¡œ ë¡œê·¸ ëœ¨ëŠ” ê±¸ ë³¼ ìˆ˜ ìˆì–´

------

### âœ… ì‹¤ìŠµ ì²´í¬ë¦¬ìŠ¤íŠ¸

-  `dmesg` ê¸°ë³¸ ì‚¬ìš©
-  `dmesg -T`ë¡œ ì‹œê°„ í™•ì¸
-  `dmesg -w`ë¡œ ì‹¤ì‹œê°„ ë¡œê·¸ ê°ì‹œ
-  `printk` ë ˆë²¨ ë³€ê²½ í›„ ë¡œê·¸ êµ¬ë¶„
-  `/dev/kmsg`, `/proc/kmsg` í™•ì¸ (ì„ íƒ)

------

### ğŸ“Œ ì°¸ê³ : ë¡œê·¸ê°€ ì•ˆ ë³´ì¼ ë•Œ ì ê²€í•  ê²ƒ

| ì›ì¸                 | í•´ê²° ë°©ë²•                 |
| -------------------- | ------------------------- |
| `printk` ë ˆë²¨ì´ ë‚®ìŒ | `dmesg -n 7` ì„¤ì •         |
| `printk()` í˜¸ì¶œ ëˆ„ë½ | `module_init()` ì—°ê²° í™•ì¸ |
| ë²„í¼ ì´ˆê³¼ë¡œ ì‚­ì œë¨   | `dmesg -w`ë¡œ ì‹¤ì‹œê°„ í™•ì¸  |
| root ê¶Œí•œ í•„ìš”       | `sudo` ë¶™ì—¬ì„œ ì‹¤í–‰        |

## 10.5 ì‹œìŠ¤í…œì½œ ì¸í„°ì…‰íŠ¸ ì˜ˆì œ

### ğŸš© ëª©ì 

**ì‹œìŠ¤í…œì½œ ì¸í„°ì…‰íŠ¸ë€?**
 ğŸ‘‰ **ì»¤ë„ì´ ì œê³µí•˜ëŠ” ì‹œìŠ¤í…œì½œì˜ ë™ì‘ì„ ê°€ë¡œì±„ì„œ ë‚´ê°€ ì›í•˜ëŠ” ë™ì‘ì„ ì‚½ì…**í•˜ëŠ” ê²ƒ.

ì£¼ë¡œ ì‚¬ìš© ëª©ì :

- ë³´ì•ˆ ëª¨ë“ˆ(ì˜ˆ: rootkit)ì´ ì‹œìŠ¤í…œì½œì„ ê°ì‹œ
- íŠ¹ì • ì‹œìŠ¤í…œì½œ ì‚¬ìš©ì„ ì œí•œí•˜ê±°ë‚˜ ë³€ì¡°
- í•™ìŠµìš©ìœ¼ë¡œ ì»¤ë„ ë‚´ë¶€ ë™ì‘ ì´í•´

------

### ğŸš« ì£¼ì˜ì‚¬í•­

- ìµœì‹  ì»¤ë„ (>= 5.x)ì€ `sys_call_table` ê¸°í˜¸ê°€ **ë‚´ë³´ë‚´ì§€ ì•ŠìŒ(export ê¸ˆì§€)** â†’ ë°”ë¡œ ì ‘ê·¼ ë¶ˆê°€
- ê°•ì œë¡œ ì ‘ê·¼í•  ê²½ìš° **ë¶ˆì•ˆì •ì„±** / **ì»¤ë„ íŒ¨ë‹‰** ë°œìƒ ê°€ëŠ¥
- ì‹¤ìŠµì€ ë°˜ë“œì‹œ **ê°€ìƒë¨¸ì‹ (VM)**ì´ë‚˜ **í…ŒìŠ¤íŠ¸ìš© ì¥ë¹„**ì—ì„œ ì§„í–‰í•  ê²ƒ

â€» í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” ì ˆëŒ€ ì‚¬ìš© X
 â€» ì‹¤ì œ ë³´ì•ˆ ëª¨ë“ˆì€ ë³´í†µ **LSM(ë¦¬ëˆ…ìŠ¤ ì‹œíë¦¬í‹° ëª¨ë“ˆ)** Hookì„ ì‚¬ìš©í•¨ (ì •ì‹ ì§€ì› API ì¡´ì¬)

------

### ğŸ—ºï¸ ì „ì²´ íë¦„

```
[ê¸°ì¡´ êµ¬ì¡°]

user-space â†’ sys_call_table[NR_openat] â†’ sys_openat()

[ì¸í„°ì…‰íŠ¸ í›„ êµ¬ì¡°]

user-space â†’ sys_call_table[NR_openat] â†’ my_sys_openat() â†’ (ì›ë˜ sys_openat í˜¸ì¶œ ê°€ëŠ¥)
```

------

### 1ï¸âƒ£ ê¸°ë³¸ ì„¤ê³„

 1ï¸âƒ£ `sys_call_table` ì£¼ì†Œ ì•Œì•„ë‚´ê¸° (ì»¤ë„ ì‹¬ë³¼ ìˆ˜ì§‘)
 2ï¸âƒ£ ì‹œìŠ¤í…œì½œ í•¸ë“¤ëŸ¬ êµì²´ (`write_cr0()`ë¡œ WP(Write Protect) ë¹„í™œì„±í™” í•„ìš”)
 3ï¸âƒ£ ìƒˆë¡œìš´ í•¸ë“¤ëŸ¬ ì‘ì„± (ex: open() í˜¸ì¶œ ê°ì§€)
 4ï¸âƒ£ ëª¨ë“ˆ ì œê±° ì‹œ ì›ìƒë³µêµ¬

------

### 2ï¸âƒ£ ì˜ˆì œ ì½”ë“œ

#### 1. ì‚¬ì „ ì¤€ë¹„

- ì‹œìŠ¤í…œì½œ í…Œì´ë¸” ì£¼ì†Œ ì•Œì•„ë‚´ê¸° â†’ `kallsyms_lookup_name()` ì‚¬ìš©
- ì»¤ë„ ì„¤ì •ì— ë”°ë¼ `kallsyms_lookup_name` ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ ë‹¬ë¼ì§ â†’ í•„ìš”ì‹œ íŒ¨ì¹˜ í•„ìš”

#### 2. ì¸í„°ì…‰íŠ¸í•  ì‹œìŠ¤í…œì½œ ê³ ë¥´ê¸°

ì—¬ê¸°ì„œëŠ” **`__x64_sys_openat` (open syscall)** ë¥¼ ì˜ˆì œë¡œ ì‚¬ìš©.

------

#### 3. ì¸í„°ì…‰íŠ¸ ëª¨ë“ˆ ì½”ë“œ (ê°•ì˜ìš© ì˜ˆì œ)

```
#include <linux/module.h>
#include <linux/kernel.h>
#include <linux/syscalls.h>
#include <linux/kallsyms.h>
#include <linux/uaccess.h>

MODULE_LICENSE("GPL");
MODULE_AUTHOR("Your Name");
MODULE_DESCRIPTION("System call intercept example");

unsigned long **sys_call_table;

asmlinkage long (*original_sys_openat)(int, const char __user *, int, umode_t);

asmlinkage long my_sys_openat(int dfd, const char __user *filename, int flags, umode_t mode) {
    char fname[256];
    long ret;

    if (strncpy_from_user(fname, filename, sizeof(fname)) > 0) {
        printk(KERN_INFO "Intercepted openat(): %s\n", fname);
    }

    ret = original_sys_openat(dfd, filename, flags, mode);

    return ret;
}

static void disable_write_protection(void) {
    unsigned long cr0;
    preempt_disable();
    barrier();
    asm volatile("mov %%cr0, %0" : "=r"(cr0));
    cr0 &= ~0x00010000;
    asm volatile("mov %0, %%cr0" : : "r"(cr0));
    barrier();
}

static void enable_write_protection(void) {
    unsigned long cr0;
    barrier();
    asm volatile("mov %%cr0, %0" : "=r"(cr0));
    cr0 |= 0x00010000;
    asm volatile("mov %0, %%cr0" : : "r"(cr0));
    barrier();
    preempt_enable();
}

static int __init interceptor_init(void) {
    sys_call_table = (unsigned long **)kallsyms_lookup_name("sys_call_table");

    if (!sys_call_table) {
        printk(KERN_ERR "Failed to locate sys_call_table\n");
        return -1;
    }

    original_sys_openat = (void *)sys_call_table[__NR_openat];

    disable_write_protection();
    sys_call_table[__NR_openat] = (unsigned long *)my_sys_openat;
    enable_write_protection();

    printk(KERN_INFO "System call openat() intercepted\n");
    return 0;
}

static void __exit interceptor_exit(void) {
    if (!sys_call_table)
        return;

    disable_write_protection();
    sys_call_table[__NR_openat] = (unsigned long *)original_sys_openat;
    enable_write_protection();

    printk(KERN_INFO "System call openat() restored\n");
}

module_init(interceptor_init);
module_exit(interceptor_exit);
```

------

### 3ï¸âƒ£ í•µì‹¬ í¬ì¸íŠ¸ ì„¤ëª…

| ë¶€ë¶„                       | ì„¤ëª…                                           |
| -------------------------- | ---------------------------------------------- |
| `kallsyms_lookup_name`     | `sys_call_table` ì£¼ì†Œ ì–»ê¸°                     |
| `disable_write_protection` | `cr0.WP` ë¹„íŠ¸ ë³€ê²½í•´ì„œ ì»¤ë„ ë©”ëª¨ë¦¬ ì“°ê¸° ê°€ëŠ¥í™” |
| `original_sys_openat` ì €ì¥ | ì›ë˜ í•¸ë“¤ëŸ¬ ë°±ì—…                               |
| `my_sys_openat` êµ¬í˜„       | ì‚¬ìš©ì ì •ì˜ í•¸ë“¤ëŸ¬ (printkë¡œ ë¡œê¹…ë§Œ)           |
| ë³µì› ê³¼ì •                  | `rmmod` ì‹œ ì›ìƒë³µêµ¬ ìˆ˜í–‰                       |

------

### 4ï¸âƒ£ ì‹¤ìŠµ ì ˆì°¨

#### 1ï¸âƒ£ ëª¨ë“ˆ ë¹Œë“œ

```
$ make
```

#### 2ï¸âƒ£ ëª¨ë“ˆ ì‚½ì…

```
$ sudo insmod interceptor.ko
$ dmesg | tail -n 10
```

#### 3ï¸âƒ£ í…ŒìŠ¤íŠ¸ â†’ ì„ì˜ì˜ íŒŒì¼ ì—´ì–´ë³´ê¸°

```
$ cat /etc/hostname
$ dmesg | tail -n 10
```

â†’ **Intercepted openat(): /etc/hostname** ì¶œë ¥ í™•ì¸

#### 4ï¸âƒ£ ëª¨ë“ˆ ì œê±°

```
$ sudo rmmod interceptor
$ dmesg | tail -n 10
```

â†’ **System call openat() restored** ë©”ì‹œì§€ í™•ì¸

------

### 5ï¸âƒ£ ì‹¤ìŠµ ì‹œ ì£¼ì˜ì 

- ìµœì‹  ì»¤ë„ì€ `kallsyms_lookup_name` ë„ `EXPORT_SYMBOL_GPL` ìƒíƒœë¼ **GPL ëª…ì‹œ í•„ìˆ˜**
- ì‹œìŠ¤í…œì½œ ì¸í„°ì…‰íŠ¸ëŠ” ë³´ì•ˆìƒ ë§¤ìš° ìœ„í—˜í•œ ê¸°ë²•ì´ë¼ **ì •ì‹ ì»¤ë„ ê°œë°œì—ì„  ê¸ˆì§€**
- í…ŒìŠ¤íŠ¸ìš©ìœ¼ë¡œë§Œ ì‹¤ìŠµ!

------

### âœ… ì‹¤ìŠµ ì²´í¬ë¦¬ìŠ¤íŠ¸

-  `kallsyms_lookup_name` ì •ìƒ ë™ì‘ í™•ì¸
-  `sys_call_table` ì£¼ì†Œ íšë“
-  ì‹œìŠ¤í…œì½œ í•¸ë“¤ëŸ¬ êµì²´ / ë³µì›
-  íŒŒì¼ ì—´ê¸° ì‹œ `dmesg`ì— ë¡œê¹… í™•ì¸
-  ì»¤ë„ íŒ¨ë‹‰ ì—†ì´ ëª¨ë“ˆ ì œê±° ì„±ê³µ

# ğŸ“ ì‹¤ìŠµ

## Hello Kernel Module ì‘ì„±

### ğŸ§± 1. ëª©í‘œ

- ë¦¬ëˆ…ìŠ¤ ì»¤ë„ ëª¨ë“ˆ ê°œë°œì˜ **ê¸°ì´ˆ êµ¬ì¡° íŒŒì•…**
- `printk()`ë¥¼ í†µí•´ **ì»¤ë„ ë©”ì‹œì§€ ì¶œë ¥**
- `insmod`, `rmmod`, `dmesg` íë¦„ì„ í†µí•œ ëª¨ë“ˆ ë¡œë“œ/ì–¸ë¡œë“œ ì²´í—˜

------

### ğŸ“ 2. ë””ë ‰í† ë¦¬ êµ¬ì„±

```
hello_module/
â”œâ”€â”€ hello.c
â””â”€â”€ Makefile
```

------

### ğŸ“„ 3. hello.c ì†ŒìŠ¤ ì½”ë“œ

```
// hello.c
#include <linux/module.h>    // ì»¤ë„ ëª¨ë“ˆ ê´€ë ¨ ë§¤í¬ë¡œ
#include <linux/kernel.h>    // printk()
#include <linux/init.h>      // __init, __exit ë§¤í¬ë¡œ

static int __init hello_init(void)
{
    printk(KERN_INFO "ğŸ”§ Hello, Kernel! Module successfully loaded.\n");
    return 0;
}

static void __exit hello_exit(void)
{
    printk(KERN_INFO "ğŸ§¹ Goodbye, Kernel! Module successfully unloaded.\n");
}

module_init(hello_init);   // ì´ˆê¸°í™” í•¨ìˆ˜ ë“±ë¡
module_exit(hello_exit);   // ì¢…ë£Œ í•¨ìˆ˜ ë“±ë¡

MODULE_LICENSE("GPL");
MODULE_AUTHOR("Your Name");
MODULE_DESCRIPTION("A basic Hello World Linux Kernel Module");
```

------

### ğŸ§¾ 4. Makefile

```
# Makefile
obj-m := hello.o

KDIR := /lib/modules/$(shell uname -r)/build
PWD := $(shell pwd)

all:
	make -C $(KDIR) M=$(PWD) modules

clean:
	make -C $(KDIR) M=$(PWD) clean
```

------

### âš™ï¸ 5. ë¹Œë“œ ê³¼ì •

```
$ make
```

ë¹Œë“œê°€ ì„±ê³µí•˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ íŒŒì¼ì´ ìƒì„±ë¼:

- `hello.ko` (ì»¤ë„ ì˜¤ë¸Œì íŠ¸ ëª¨ë“ˆ)
- `hello.mod.c`, `hello.o`, `.mod.o`, `.symvers` ë“± ì¤‘ê°„ íŒŒì¼ë“¤

------

### ğŸ“¦ 6. ëª¨ë“ˆ ì‚½ì… ë° í™•ì¸

```
$ sudo insmod hello.ko
$ dmesg | tail -n 10
```

â†’ ì¶œë ¥ ì˜ˆì‹œ:

```
[ 1234.56789] ğŸ”§ Hello, Kernel! Module successfully loaded.
```

------

### ğŸ§¹ 7. ëª¨ë“ˆ ì œê±° ë° ë¡œê·¸ í™•ì¸

```
$ sudo rmmod hello
$ dmesg | tail -n 10
```

â†’ ì¶œë ¥ ì˜ˆì‹œ:

```
[ 1236.78900] ğŸ§¹ Goodbye, Kernel! Module successfully unloaded.
```

------

### ğŸ§ª 8. ì‹¤ìŠµ ì²´í¬ë¦¬ìŠ¤íŠ¸

| í•­ëª©                   | ì™„ë£Œ ì—¬ë¶€ |
| ---------------------- | --------- |
| `hello.c` ì‘ì„± ì™„ë£Œ âœ…  | âœ…         |
| `Makefile` ìƒì„± âœ…      | âœ…         |
| `make`ë¡œ `.ko` ë¹Œë“œ âœ…  | âœ…         |
| `insmod`ë¡œ ì»¤ë„ ì‚½ì… âœ… | âœ…         |
| `dmesg`ë¡œ ë¡œê·¸ í™•ì¸ âœ…  | âœ…         |
| `rmmod`ë¡œ ì œê±° âœ…       | âœ…         |

------

### ğŸ“Œ 9. ê¶Œì¥ í›„ì† ì‹¤ìŠµ

-  `printk()` ë¡œê·¸ ë ˆë²¨ ë‹¤ì–‘í•˜ê²Œ ì‹¤í—˜
-  `module_param()`ìœ¼ë¡œ ëª¨ë“ˆ íŒŒë¼ë¯¸í„° ì „ë‹¬
-  `/proc` ë…¸ë“œ ìƒì„± (`proc_create()`)
-  `init_module()`ê³¼ `cleanup_module()` ì§ì ‘ ì¨ë³´ê¸° (ì˜› ë°©ì‹)

## `/proc/myinfo` ê°€ìƒíŒŒì¼ ì‹œìŠ¤í…œ ìƒì„±

### ğŸ—ºï¸ ê°œë… ì •ë¦¬

| ê°œë…           | ì„¤ëª…                                                         |
| -------------- | ------------------------------------------------------------ |
| `/proc`        | ì»¤ë„ ë‚´ë¶€ ì •ë³´ë¥¼ ì‚¬ìš©ì ê³µê°„ì— ë…¸ì¶œí•˜ëŠ” íŠ¹ìˆ˜ ê°€ìƒ íŒŒì¼ ì‹œìŠ¤í…œ |
| ê°€ìƒ íŒŒì¼ ë…¸ë“œ | ì‹¤ì œë¡œëŠ” ë””ìŠ¤í¬ì— ì¡´ì¬í•˜ì§€ ì•ŠìŒ â†’ ì»¤ë„ ë©”ëª¨ë¦¬ë¥¼ í†µí•´ ì‹¤ì‹œê°„ ìƒì„± |
| ì£¼ìš” ì‚¬ìš© ì˜ˆ   | ë””ë²„ê·¸ ì •ë³´, ìƒíƒœ ì •ë³´ ì œê³µ                                  |

ìš°ë¦¬ê°€ ë§Œë“¤ `/proc/myinfo`ëŠ”:

```
$ cat /proc/myinfo
â†’ "Hello from my kernel module!"
```

ë¥¼ ì¶œë ¥í•˜ê²Œ ë§Œë“¤ ê±°ì•¼.

------

### 1ï¸âƒ£ ì»¤ë„ API ì¤€ë¹„

ìš°ë¦¬ëŠ” `proc_create()` í•¨ìˆ˜ì™€ `struct proc_ops` êµ¬ì¡°ì²´ë¥¼ ì‚¬ìš©í•  ê±°ì•¼.
 (ì´ì „ ì»¤ë„ì—ì„œëŠ” `struct file_operations` ì‚¬ìš©í–ˆìœ¼ë‚˜ ìµœì‹  ì»¤ë„ì€ `proc_ops`ê°€ ê¶Œì¥ë¨.)

------

### 2ï¸âƒ£ ì „ì²´ ì½”ë“œ ì˜ˆì œ (`hello_proc.c`)

```
// hello_proc.c
#include <linux/module.h>
#include <linux/kernel.h>
#include <linux/init.h>
#include <linux/proc_fs.h>
#include <linux/seq_file.h>

#define PROC_NAME "myinfo"

static int myinfo_show(struct seq_file *m, void *v)
{
    seq_printf(m, "Hello from my kernel module!\n");
    seq_printf(m, "Kernel version: %s\n", UTS_RELEASE);
    return 0;
}

static int myinfo_open(struct inode *inode, struct file *file)
{
    return single_open(file, myinfo_show, NULL);
}

static const struct proc_ops myinfo_fops = {
    .proc_open    = myinfo_open,
    .proc_read    = seq_read,
    .proc_lseek   = seq_lseek,
    .proc_release = single_release,
};

static int __init hello_proc_init(void)
{
    proc_create(PROC_NAME, 0, NULL, &myinfo_fops);
    printk(KERN_INFO "/proc/%s created\n", PROC_NAME);
    return 0;
}

static void __exit hello_proc_exit(void)
{
    remove_proc_entry(PROC_NAME, NULL);
    printk(KERN_INFO "/proc/%s removed\n", PROC_NAME);
}

module_init(hello_proc_init);
module_exit(hello_proc_exit);

MODULE_LICENSE("GPL");
MODULE_AUTHOR("Your Name");
MODULE_DESCRIPTION("A simple /proc/myinfo kernel module");
```

------

### 3ï¸âƒ£ í•µì‹¬ ì„¤ëª…

| êµ¬ì„± ìš”ì†Œ           | ì„¤ëª…                                             |
| ------------------- | ------------------------------------------------ |
| `proc_create`       | `/proc`ì— ìƒˆë¡œìš´ íŒŒì¼ ìƒì„±                       |
| `myinfo_show`       | íŒŒì¼ ë‚´ìš© ì¶œë ¥ í•¨ìˆ˜ â†’ `seq_file` ì¸í„°í˜ì´ìŠ¤ ì‚¬ìš© |
| `single_open`       | íŒŒì¼ ì—´ê¸° ì‹œ ë™ì‘ ì—°ê²°                           |
| `proc_ops`          | ìµœì‹  ì»¤ë„ì—ì„œ ì‚¬ìš©ë˜ëŠ” proc íŒŒì¼ìš© ops êµ¬ì¡°ì²´    |
| `remove_proc_entry` | ëª¨ë“ˆ ì œê±° ì‹œ `/proc` ë…¸ë“œ ì‚­ì œ                   |

#### `seq_file` ì¸í„°í˜ì´ìŠ¤

- `/proc` íŒŒì¼ì— *ë²„í¼ ì—†ì´ ì•ˆì „í•˜ê²Œ ë¬¸ìì—´ ì¶œë ¥* ì§€ì›
- `seq_printf()` ì‚¬ìš©

------

### 4ï¸âƒ£ Makefile ì˜ˆì‹œ

```
obj-m := hello_proc.o

KDIR := /lib/modules/$(shell uname -r)/build
PWD := $(shell pwd)

all:
	make -C $(KDIR) M=$(PWD) modules

clean:
	make -C $(KDIR) M=$(PWD) clean
```

------

### 5ï¸âƒ£ ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸

```
$ make
$ sudo insmod hello_proc.ko
$ dmesg | tail -n 10
â†’ "/proc/myinfo created" í™•ì¸

$ cat /proc/myinfo
Hello from my kernel module!
Kernel version: 6.x.x-xxx-generic
```

#### ëª¨ë“ˆ ì œê±°

```
$ sudo rmmod hello_proc
$ dmesg | tail -n 10
â†’ "/proc/myinfo removed" í™•ì¸

$ cat /proc/myinfo
â†’ No such file or directory (ì •ìƒ ë™ì‘)
```

------

### âœ… ì‹¤ìŠµ ì²´í¬ë¦¬ìŠ¤íŠ¸

-  `hello_proc.c` ì‘ì„±
-  `Makefile` ì‘ì„±
-  `make` ì„±ê³µ
-  `/proc/myinfo` ìƒì„± í™•ì¸
-  `cat /proc/myinfo` ë‚´ìš© í™•ì¸
-  ëª¨ë“ˆ ì œê±° í›„ íŒŒì¼ ì‚¬ë¼ì§ í™•ì¸

------

### ğŸ“Œ í™•ì¥ í•™ìŠµ ë°©í–¥

| ì£¼ì œ                                                         | ì„¤ëª… |
| ------------------------------------------------------------ | ---- |
| `seq_printf()`ë¡œ **ë™ì  ì •ë³´** ì¶œë ¥í•˜ê¸° (ex: CPU usage, counter ë“±) |      |
| `/proc/myinfo` â†’ **ì“°ê¸° ê°€ëŠ¥**í•˜ê²Œ ë§Œë“¤ê¸° (`proc_write` ì¶”ê°€) |      |
| ì„œë¸Œë””ë ‰í† ë¦¬ ìƒì„± (`proc_mkdir()`)                           |      |
| `/proc/my_module/status` ì™€ ê°™ì´ **ë‹¤ì¤‘ íŒŒì¼ êµ¬ì¡° ë§Œë“¤ê¸°**   |      |

## ì‹œìŠ¤í…œ ì½œ í›„í‚¹ í…ŒìŠ¤íŠ¸

### 1ï¸âƒ£ ëª©í‘œ

- ì‹œìŠ¤í…œ ì½œ í…Œì´ë¸”(`sys_call_table`)ì—ì„œ íŠ¹ì • ì‹œìŠ¤í…œ ì½œì„ **ê°€ë¡œì±„ê¸°**
- í›„í‚¹ëœ í•¨ìˆ˜ì—ì„œ `printk()`ë¡œ **ë¡œê¹…** ìˆ˜í–‰
- ì›ë˜ ì‹œìŠ¤í…œ ì½œ í˜¸ì¶œì€ ìœ ì§€
- í›„í‚¹ â†’ í…ŒìŠ¤íŠ¸ â†’ ë³µì› ìˆœìœ¼ë¡œ íë¦„ì„ í™•ì¸

------

### 2ï¸âƒ£ ì „ì œì¡°ê±´

- **ì»¤ë„ ë¹Œë“œ ì˜µì…˜ì´ kallsyms_lookup_name í—ˆìš© ìƒíƒœì¼ ê²ƒ**
- ì»¤ë„ì´ `sys_call_table`ì„ export í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ â†’ ë°˜ë“œì‹œ `kallsyms_lookup_name()`ìœ¼ë¡œ ê°€ì ¸ì™€ì•¼ í•¨
- í…ŒìŠ¤íŠ¸ í™˜ê²½ì€ **ê°€ìƒë¨¸ì‹  ì¶”ì²œ** (í¬ë˜ì‹œ ë°œìƒ ê°€ëŠ¥ì„± ì¡´ì¬)

------

### 3ï¸âƒ£ í›„í‚¹ ëŒ€ìƒ ì„ ì •

ì´ë²ˆ í…ŒìŠ¤íŠ¸ì—ì„œëŠ” â†’ `__x64_sys_openat` (ì¦‰, ìœ ì €ê°€ íŒŒì¼ì„ ì—´ ë•Œ í˜¸ì¶œë˜ëŠ” ì‹œìŠ¤í…œ ì½œ)ì„ í›„í‚¹í•´ë³¼ê²Œ.

> ì™œ openat()ëƒ?
>  â†’ open()ì€ ìµœì‹  glibcì—ì„œ openat()ìœ¼ë¡œ ë‚´ë¶€ ë³€í™˜ë¼ì„œ í˜¸ì¶œë¨.
>  ë”°ë¼ì„œ openat() í›„í‚¹ì´ íš¨ê³¼ì ì„.

------

### 4ï¸âƒ£ ì „ì²´ ì½”ë“œ ì˜ˆì œ (í›„í‚¹ í…ŒìŠ¤íŠ¸ìš©)

**`syscall_hook.c`**

```
#include <linux/module.h>
#include <linux/kernel.h>
#include <linux/init.h>
#include <linux/syscalls.h>
#include <linux/kallsyms.h>
#include <linux/uaccess.h>
#include <linux/unistd.h>

MODULE_LICENSE("GPL");
MODULE_AUTHOR("Your Name");
MODULE_DESCRIPTION("System Call Hook Test");

unsigned long **sys_call_table;
asmlinkage long (*original_sys_openat)(int dfd, const char __user *filename, int flags, umode_t mode);

asmlinkage long my_sys_openat(int dfd, const char __user *filename, int flags, umode_t mode)
{
    char fname[256];

    if (strncpy_from_user(fname, filename, sizeof(fname)) > 0)
    {
        printk(KERN_INFO "HOOKED openat(): %s\n", fname);
    }

    // ì›ë˜ ì‹œìŠ¤í…œ ì½œ í˜¸ì¶œ
    return original_sys_openat(dfd, filename, flags, mode);
}

static void disable_wp(void)
{
    unsigned long cr0;
    preempt_disable();
    barrier();
    asm volatile("mov %%cr0, %0" : "=r"(cr0));
    cr0 &= ~0x00010000;
    asm volatile("mov %0, %%cr0" : : "r"(cr0));
    barrier();
}

static void enable_wp(void)
{
    unsigned long cr0;
    barrier();
    asm volatile("mov %%cr0, %0" : "=r"(cr0));
    cr0 |= 0x00010000;
    asm volatile("mov %0, %%cr0" : : "r"(cr0));
    barrier();
    preempt_enable();
}

static int __init hook_init(void)
{
    sys_call_table = (unsigned long **)kallsyms_lookup_name("sys_call_table");

    if (!sys_call_table)
    {
        printk(KERN_ERR "Failed to find sys_call_table\n");
        return -1;
    }

    original_sys_openat = (void *)sys_call_table[__NR_openat];

    disable_wp();
    sys_call_table[__NR_openat] = (unsigned long *)my_sys_openat;
    enable_wp();

    printk(KERN_INFO "System call openat() hooked\n");
    return 0;
}

static void __exit hook_exit(void)
{
    if (sys_call_table)
    {
        disable_wp();
        sys_call_table[__NR_openat] = (unsigned long *)original_sys_openat;
        enable_wp();

        printk(KERN_INFO "System call openat() restored\n");
    }
}

module_init(hook_init);
module_exit(hook_exit);
```

------

### 5ï¸âƒ£ Makefile

```
obj-m := syscall_hook.o

KDIR := /lib/modules/$(shell uname -r)/build
PWD := $(shell pwd)

all:
	make -C $(KDIR) M=$(PWD) modules

clean:
	make -C $(KDIR) M=$(PWD) clean
```

------

### 6ï¸âƒ£ ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ì ˆì°¨

#### ë¹Œë“œ

```
$ make
```

#### ëª¨ë“ˆ ì‚½ì…

```
$ sudo insmod syscall_hook.ko
$ dmesg | tail -n 10
â†’ "System call openat() hooked" í™•ì¸
```

#### í…ŒìŠ¤íŠ¸

```
$ cat /etc/hostname
```

#### dmesg í™•ì¸

```
$ dmesg | tail -n 10
```

â†’ ì˜ˆì‹œ ì¶œë ¥:

```
[ ... ] HOOKED openat(): /etc/hostname
```

#### ëª¨ë“ˆ ì œê±°

```
$ sudo rmmod syscall_hook
$ dmesg | tail -n 10
â†’ "System call openat() restored" í™•ì¸
```

------

### âœ… ì‹¤ìŠµ ì²´í¬ë¦¬ìŠ¤íŠ¸

| í•­ëª©                              | ì™„ë£Œ ì—¬ë¶€ |
| --------------------------------- | --------- |
| `sys_call_table` ì£¼ì†Œ í™•ë³´        | âœ…         |
| ì‹œìŠ¤í…œ ì½œ í•¸ë“¤ëŸ¬ êµì²´ â†’ ì •ìƒ ë™ì‘ | âœ…         |
| `HOOKED openat()` ì¶œë ¥ í™•ì¸       | âœ…         |
| ì›ë˜ ì‹œìŠ¤í…œ ì½œ ì •ìƒ ë³µì›          | âœ…         |
| ì»¤ë„ íŒ¨ë‹‰ ì—†ì´ ëª¨ë“ˆ ì œê±° ì„±ê³µ     | âœ…         |

------

### ğŸ“Œ ì£¼ì˜ì‚¬í•­

| ë¬¸ì œ ìƒí™©                        | ì›ì¸                                         |
| -------------------------------- | -------------------------------------------- |
| kallsyms_lookup_name() ì‚¬ìš© ë¶ˆê°€ | ì»¤ë„ êµ¬ì„±ì— ë”°ë¼ ì œí•œ ê°€ëŠ¥ (CONFIG_KALLSYMS) |
| write_cr0 ì‚¬ìš© ë¶ˆê°€              | ìµœì‹  ì»¤ë„ì—ì„œëŠ” ì¼ë¶€ ë³´ì•ˆ íŒ¨ì¹˜ ì ìš©ë¨        |
| ì»¤ë„ íŒ¨ë‹‰ ë°œìƒ                   | ì‹œìŠ¤í…œ ì½œ ë³µì› ì‹¤íŒ¨, WP ë¯¸ë³µì›               |
| rmmod ê°•ì œ ì‹¤íŒ¨                  | `sys_call_table` ë³µì› ì •í™•íˆ í™•ì¸ í•„ìš”       |

------

### ğŸš€ í™•ì¥ ë°©í–¥

-  ì—¬ëŸ¬ ì‹œìŠ¤í…œ ì½œ ë™ì‹œ í›„í‚¹ (ex: read, write)
-  ì»¤ë„ ë²„ì „ ë³„ ì°¨ì´ ëŒ€ì‘ (sys_call_table ìœ„ì¹˜ ë‹¬ë¼ì§)
-  syscall ì¸í„°ì…‰íŠ¸ â†’ ë™ì  ì •ì±… ì ìš© (í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸/ë¸”ë™ë¦¬ìŠ¤íŠ¸)
-  Shadow syscall table ì‚¬ìš© (ì¼ë¶€ LSM ê¸°ë°˜ ê¸°ë²• í•™ìŠµ)